1. æŒæ¡ Java æ ¸å¿ƒçŸ¥è¯†
1.1 IoC æ§åˆ¶åè½¬ï¼šä¸€ç§è®¾è®¡æ€æƒ³/åŸåˆ™ã€‚
æ ¸å¿ƒï¼šå¯¹è±¡ä¸åˆ›å»ºä¾èµ–ï¼Œè€Œæ˜¯ä¾èµ–ç”±â€œå¤–éƒ¨å®¹å™¨â€æä¾›ã€‚

DI ä¾èµ–æ³¨å…¥ï¼šæ˜¯å®ç°IoCçš„ä¸»è¦æŠ€æœ¯æ‰‹æ®µã€‚Springä½¿ç”¨DIæ¥å®ç°IoCã€‚

class UserService {
    private UserRepository repo;

    public UserService(UserRepository repo) {
        this.repo = repo;
    }
}

ç„¶åç”± Spring æ¥åšè¿™ä»¶äº‹ï¼š
@Bean
public UserService userService(UserRepository repo) {
    return new UserService(repo);
}

1.2 é¢å‘åˆ‡é¢ç¼–ç¨‹(AOP, Aspect Oriented Programming)ï¼šæ”¯æŒæ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–
Spring AOP = åœ¨ä¸æ”¹ä¸šåŠ¡ä»£ç çš„æƒ…å†µä¸‹ï¼Œç»™æ–¹æ³•â€œå¤–æŒ‚â€ä¸€æ®µé€»è¾‘

æ¯”å¦‚ï¼š
æ‰“æ—¥å¿—
ç»Ÿè®¡è€—æ—¶
æƒé™æ ¡éªŒ
äº‹åŠ¡æ§åˆ¶

@Around æ˜¯æœ€å¼ºçš„ Adviceï¼Œäº‹åŠ¡ã€é‡è¯•ã€ç¼“å­˜ï¼Œå¿…é¡»ç”¨ @Aroundã€‚

1.3 volatile ä¿®é¥°ç¬¦
public class MyRunnable implements Runnable
{
    private volatile boolean active;
    public void run()
    {
        active = true;
        while (active) // ç¬¬ä¸€è¡Œ
        {
            // ä»£ç 
        }
    }
    public void stop()
    {
        active = false; // ç¬¬äºŒè¡Œ
    }
}

å¤šçº¿ç¨‹ï¼š
run() åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œè·‘
stop() åœ¨å¦ä¸€ä¸ªçº¿ç¨‹é‡Œè°ƒç”¨

å¤šçº¿ç¨‹åŒäº«åŒä¸€ä¸ªå˜é‡ activeã€‚è¿™æ˜¯ Java å†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ çš„èƒ½åŠ›ã€‚

å¦‚æœæ²¡æœ‰volatileï¼ŒJVMä¼šæŠŠ active ç¼“å­˜åœ¨CPUå¯„å­˜å™¨é‡Œï¼Œå¯¼è‡´whileæ°¸è¿œè¯»ä¸åˆ°falseã€‚volatileä¿è¯ä¸ç¼“å­˜ï¼Œæ¯æ¬¡ä»ä¸»å†…å­˜è¯»ã€‚

åˆ†æï¼š
å¯„å­˜å™¨ç¼“å­˜æ˜¯ç¼–è¯‘å™¨/JITçš„ä¼˜åŒ–è¡Œä¸ºï¼Œç›®çš„æ˜¯å‡å°‘æ˜‚è´µçš„å†…å­˜è®¿é—®ã€‚
volatileé€šè¿‡å†…å­˜å±éšœé˜»æ­¢è¿™ç§ä¼˜åŒ–ï¼Œä¿è¯æ¯æ¬¡ä»ä¸»å†…å­˜è¯»å–ã€‚
é—®é¢˜ä¸åªæ˜¯å¯„å­˜å™¨ï¼Œè¿˜åŒ…æ‹¬CPUç¼“å­˜ä¸€è‡´æ€§ã€å†™ç¼“å†²åŒºç­‰ã€‚

è®¡ç®—æœºå­˜å‚¨å±‚æ¬¡ç»“æ„ï¼š
CPUæ€§èƒ½ï¼šå¯„å­˜å™¨ > L1ç¼“å­˜ > L2ç¼“å­˜ > L3ç¼“å­˜ > ä¸»å†…å­˜ > ç£ç›˜
è®¿é—®é€Ÿåº¦ï¼š0.5ns   > 1ns   > 3ns   > 10ns   > 100ns  > 10ms
å®¹é‡å¤§å°ï¼šKBçº§åˆ«  < MBçº§åˆ« < MBçº§åˆ« < MBçº§åˆ« < GBçº§åˆ« < TBçº§åˆ«

JVMä¸ä¼šæŠŠæ•´ä¸ªå˜é‡"å­˜å‚¨"åœ¨å¯„å­˜å™¨é‡Œé•¿æœŸä¿å­˜ã€‚å‡†ç¡®çš„è¯´æ³•æ˜¯ï¼š
// è¯¯è§£ï¼šæŠŠactiveå˜é‡å­˜å‚¨åœ¨å¯„å­˜å™¨é‡Œ
å¯„å­˜å™¨[active] = true;  // âŒ ä¸æ˜¯è¿™æ ·ï¼

// å®é™…ï¼šæŠŠactiveçš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨è¿›è¡Œè¿ç®—
boolean temp = active;  // åŠ è½½åˆ°å¯„å­˜å™¨
while (temp) {          // ä½¿ç”¨å¯„å­˜å™¨ä¸­çš„å€¼
    // å¾ªç¯ä½“
}
// ä¹‹åå¯„å­˜å™¨å¯èƒ½è¢«é‡ç”¨


"å¯„å­˜å™¨ç¼“å­˜"çš„çœŸæ­£å«ä¹‰ï¼Œä¸æ˜¯ç‰©ç†å­˜å‚¨ï¼Œè€Œæ˜¯è®¿é—®è·¯å¾„ä¼˜åŒ–ï¼š
æ²¡æœ‰ä¼˜åŒ–çš„æƒ…å†µï¼ˆvolatileä¿è¯ï¼‰ï¼š
å¾ªç¯å¼€å§‹ â†’ è¯»å–å†…å­˜ â†’ CPUç¼“å­˜ â†’ å¯„å­˜å™¨ â†’ åˆ¤æ–­ â†’ å¾ªç¯ä½“
      â†‘                                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–åçš„æƒ…å†µï¼š
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                                   â”‚
å¾ªç¯å¼€å§‹ â†’ å¯„å­˜å™¨(å·²æœ‰å€¼) â†’ åˆ¤æ–­ â†’ å¾ªç¯ä½“
      â†‘                                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      
å…³é”®ï¼šä¼˜åŒ–åå®Œå…¨ç»•è¿‡äº†"è¯»å–å†…å­˜"è¿™ä¸ªæ­¥éª¤ï¼



PHPé»˜è®¤æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œæ‰€ä»¥æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚


1.4 synchronized ä¿®é¥°ç¬¦
synchronized å…³é”®å­—å£°æ˜çš„æ–¹æ³•åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è®¿é—®ã€‚

ä¿è¯äº†åŸå­æ€§ï¼Œé€šè¿‡ â€œäº’æ–¥é”â€ æœºåˆ¶ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è¿›å…¥åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•ã€‚åŸå­æ€§çš„æ„æ€æ˜¯ä¸å¯åˆ†å‰²äº†ï¼Œè¯»â†’æ”¹â†’å†™ ä¸‰æ­¥æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œéƒ½è¦æ‰§è¡Œå®Œäº†æ‰é‡Šæ”¾é”ã€‚

å®ä¾‹
class Account {
    private int balance = 100;

    public synchronized void draw(int amount) {
        if (balance > amount) {
            System.out.println("æ­£åœ¨å–é’±");
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {}
            balance -= amount;
            System.out.println("å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š" + balance);
        } else {
            System.out.println("ä½™é¢ä¸è¶³ï¼Œä½™é¢ä¸ºï¼š" + balance);
        }
    }
}

// æµ‹è¯•å¤šçº¿ç¨‹
class TestSynchronized {
    public static void main(String[] args) {
        Account account = new Account();

        Runnable r1 = new Runnable() {
            @Override
            public void run() {
                account.draw(80);
            }
        };

        Thread t1 = new Thread(r1);
        Thread t2 = new Thread(r1);

        t1.start();
        t2.start();
    }
}

çº¿ç¨‹å®‰å…¨çš„è¾“å‡ºï¼š
æ­£åœ¨å–é’±
å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š20
ä½™é¢ä¸è¶³ï¼Œä½™é¢ä¸ºï¼š20

å¦‚æœå»æ‰ synchronizedï¼Œåˆ™å¯èƒ½è¾“å‡ºï¼š
æ­£åœ¨å–é’±
æ­£åœ¨å–é’±
å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š-60
å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š-60

æ­£åœ¨å–é’±
æ­£åœ¨å–é’±
å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š20
å–å®Œé’±ï¼Œä½™é¢ä¸ºï¼š20

ä»£ç åˆ†æï¼šsynchronized å·²ç»ä¿è¯äº†balanceäº’æ–¥ + å¯è§æ€§ã€‚æ‰€ä»¥ä¸éœ€è¦åŠ ä¸Švolatileã€‚
å½“çº¿ç¨‹é€€å‡º synchronized æ–¹æ³•/å—æ—¶ï¼Œä¼šæŠŠå¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ åˆ·æ–°åˆ°ä¸»å†…å­˜ã€‚
å½“å…¶ä»–çº¿ç¨‹è¿›å…¥ synchronized æ–¹æ³•/å—æ—¶ï¼Œä¼š é‡æ–°ä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼ã€‚

1.5 transient ä¿®é¥°ç¬¦
transient ä¿®é¥°çš„æˆå‘˜å˜é‡ï¼Œåœ¨å¯¹è±¡åºåˆ—åŒ–æ—¶ä¼šè¢«å¿½ç•¥ï¼Œä¸ä¼šå†™å…¥å­—èŠ‚æµã€‚ä¾‹å¦‚å¯†ç ä¸éœ€è¦æ˜¾ç¤ºå‡ºæ¥ï¼Œé‚£åºåˆ—åŒ–æ—¶ï¼Œå°±ä¸æ˜¾ç¤ºã€‚

1.6 
String s1 = "Runoob"; ä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡æ± 
String s4 = new String("Runoob"); åœ¨å †é‡Œæ–°å»ºå¯¹è±¡ã€‚å…ˆæ£€æŸ¥å¸¸é‡æ± ï¼Œè¿™ä¸€æ­¥åŒs1ï¼Œç„¶ååœ¨å †é‡Œåˆ›å»ºä¸€ä¸ªStringå¯¹è±¡ï¼Œé‡Œé¢åˆæœ‰ä¸€ä¸ª"Runoob"ã€‚


System.out.println(s1 == s4); // false
System.out.println(s1.equals(s4)); // true

ä¸€èˆ¬ä¸ä½¿ç”¨new String()ï¼Œå¤šå å†…å­˜ã€æ€§èƒ½å·®ã€‚

åŸå› ï¼š
== æ¯”çš„æ˜¯ å¼•ç”¨åœ°å€
equals() æ¯”çš„æ˜¯ å†…å®¹

1.7
| å†…å­˜åŒºåŸŸ                              | å­˜å‚¨å†…å®¹                                   |
| --------------------------------- | -------------------------------------- |
| **å †ï¼ˆHeapï¼‰**                       | `new` åˆ›å»ºçš„å¯¹è±¡ã€å¯¹è±¡é‡Œçš„æˆå‘˜å˜é‡ã€æ•°ç»„ã€**å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString Poolï¼‰** |
| **æ ˆï¼ˆStackï¼‰**                      | å±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°ã€**åŸºæœ¬ç±»å‹å€¼**ã€å¯¹è±¡å¼•ç”¨ï¼Œä¾‹å¦‚boolean b = true; b å’Œ true éƒ½åœ¨ æ ˆ               |
| **è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰** | ç¼–è¯‘æœŸå¸¸é‡ã€ç¬¦å·å¼•ç”¨ï¼ˆç±»/æ–¹æ³•/å­—æ®µçš„å…ƒæ•°æ®å¼•ç”¨ï¼‰              |
| **å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰**                | ç±»å…ƒæ•°æ®ã€æ–¹æ³•ä¿¡æ¯ã€**é™æ€å˜é‡ï¼ˆstatic å­—æ®µï¼‰**          |


å¤§ä¾‹å­ï¼š
public class MemoryExample {

    // ------------------- å…ƒç©ºé—´ -------------------
    // é™æ€å­—æ®µï¼Œå­˜å‚¨åœ¨å…ƒç©ºé—´
    public static int staticCounter = 0;

    // ç¼–è¯‘æœŸå¸¸é‡ï¼Œå­˜å‚¨åœ¨å…ƒç©ºé—´ + è¿è¡Œæ—¶å¸¸é‡æ± 
    public static final double PI = 3.14159;
    public static final String GREETING = "Hello, JVM!";

    // ------------------- å¯¹è±¡å­—æ®µï¼ˆå †ï¼‰ -------------------
    private int instanceValue;            // æ™®é€šå¯¹è±¡å­—æ®µ â†’ å †
    private volatile boolean flag;        // volatile å¯¹è±¡å­—æ®µ â†’ å †
    private String instanceString;        // å¯¹è±¡å­—æ®µå¼•ç”¨ â†’ å †ï¼ˆå¼•ç”¨åœ¨å †ï¼ŒæŒ‡å‘ String Pool æˆ–å †ï¼‰

    public MemoryExample(String str) {
        this.instanceValue = 42;
        this.flag = true;
        this.instanceString = str; // å¯ä»¥æŒ‡å‘å¸¸é‡æ± é‡Œçš„å­—ç¬¦ä¸²
    }

    public void runExample() {
        // ------------------- æ ˆ -------------------
        int localVar = 10;                // æ ˆ
        boolean localFlag = false;        // æ ˆ
        String localString = "Local String"; // æ ˆé‡Œå¼•ç”¨ï¼ŒæŒ‡å‘å¸¸é‡æ± æˆ–å †

        MemoryExample localObj = new MemoryExample("Instance String"); 
        // localObj å¼•ç”¨åœ¨æ ˆï¼ŒMyExample å¯¹è±¡åœ¨å †
    }

    public static void main(String[] args) {
        // æ ˆ
        MemoryExample example = new MemoryExample(GREETING); // example å¼•ç”¨åœ¨æ ˆï¼Œå¯¹è±¡åœ¨å †
        example.runExample();
    }
}


å †(Heap)ï¼š
Person p = new Person();
int[] arr = new int[]{1, 2, 3};
String s = "hello"; // "hello" åœ¨ String Poolï¼ˆå †ä¸­ï¼‰

æ ˆï¼ˆStackï¼‰ï¼š
void test() {
    int a = 1;          // a å’Œ 1 åœ¨æ ˆ
    boolean b = true;   // b å’Œ true åœ¨æ ˆ
    Person p = new Person(); // p åœ¨æ ˆï¼ŒæŒ‡å‘å †ã€‚pé‡Œçš„æˆå‘˜å˜é‡éƒ½åœ¨å¯¹è±¡pæ‰€åœ¨çš„å †é‡Œã€‚
}

è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰
public class A {
    static final int X = 10; // 10 çš„å¸¸é‡ä¿¡æ¯
    void foo() {}
}
// Aã€fooã€X ç­‰ç¬¦å·å¼•ç”¨å­˜åœ¨è¿è¡Œæ—¶å¸¸é‡æ± 

å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰ï¼š
class User {
    static int count = 0; // count å­˜åœ¨å…ƒç©ºé—´
    void login() {}
}
// User çš„ç±»ç»“æ„ã€æ–¹æ³•è¡¨éƒ½åœ¨ Metaspace


| å†…å­˜åŒºåŸŸ                              | ä¼šä¸ä¼šè¢« GCï¼Ÿ | åŸå›  / è¯´æ˜                                                                       |
| --------------------------------- | -------- | ----------------------------------------------------------------------------- |
| **å †ï¼ˆHeapï¼‰**                       | âœ… ä¼š      | å †æ˜¯åƒåœ¾å›æ”¶çš„ä¸»è¦æˆ˜åœºã€‚**æ‰€æœ‰ `new` å‡ºæ¥çš„å¯¹è±¡**ï¼Œæ•°ç»„ï¼Œä»¥åŠå­—ç¬¦ä¸²å¸¸é‡æ± å¯¹è±¡ï¼ˆString Poolï¼‰éƒ½åœ¨å †é‡Œï¼Œ**æ— å¼•ç”¨æ—¶ GC å›æ”¶**ã€‚ |
| **æ ˆï¼ˆStackï¼‰**                      | âŒ ä¸ä¼š     | æ ˆæ˜¯æ–¹æ³•è°ƒç”¨çš„ä¸´æ—¶ç©ºé—´ï¼Œå±€éƒ¨å˜é‡ã€æ–¹æ³•å‚æ•°ã€åŸºæœ¬ç±»å‹å€¼ã€å¯¹è±¡å¼•ç”¨éƒ½åœ¨æ ˆä¸­ï¼Œ**æ ˆå¸§å‡ºæ ˆæ—¶è‡ªåŠ¨é‡Šæ”¾**ï¼Œæ— éœ€ GCã€‚                     |
| **è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Poolï¼‰** | âœ… éƒ¨åˆ†å¯å›æ”¶  | è¿è¡Œæ—¶å¸¸é‡æ± åœ¨ **ç±»å…ƒæ•°æ®é‡Œ**ï¼Œå±äºå †çš„ä¸€éƒ¨åˆ†ã€‚å¸¸é‡æ± ä¸­çš„**ç¬¦å·å¼•ç”¨æˆ–å­—é¢é‡å¸¸é‡**å¦‚æœ**æ²¡æœ‰è¢«ä»»ä½•å¼•ç”¨ä½¿ç”¨**ï¼Œå¯ä»¥è¢« GC å›æ”¶ã€‚       |
| **å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰**                | âœ… éƒ¨åˆ†å¯å›æ”¶  | å…ƒç©ºé—´å­˜å‚¨ç±»å…ƒæ•°æ®å’Œé™æ€å˜é‡ã€‚**ç±»è¢«å¸è½½æ—¶**ï¼Œå¯¹åº”å…ƒç©ºé—´å†…å­˜ä¼šè¢«å›æ”¶ï¼›é™æ€å˜é‡åªè¦ç±»è¿˜åœ¨ï¼Œå°±ä¸ä¼šè¢«å›æ”¶ã€‚                        |


1ï¼‰â€œåœ¨Javaåº”ç”¨ä¸­ï¼Œå †å†…å­˜é€šå¸¸æ¯”æ ˆå†…å­˜å¤§1-2ä¸ªæ•°é‡çº§â€
å› ä¸ºå †å­˜å‚¨æ‰€æœ‰å¯¹è±¡ï¼Œæ ˆåªå­˜å‚¨åŸºæœ¬ç±»å‹å’Œå¼•ç”¨

2ï¼‰â€œæ ˆå†…å­˜æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œæ€»æ ˆå†…å­˜ = çº¿ç¨‹æ•° Ã— æ ˆå¤§å°â€
çº¿ç¨‹è¿‡å¤šæ—¶ï¼Œæ ˆå†…å­˜å¯èƒ½å¾ˆå¤§

3ï¼‰â€œå †å†…å­˜æ˜¯å…¨å±€å…±äº«çš„ï¼Œå­˜å‚¨æ‰€æœ‰å¯¹è±¡å®ä¾‹â€
ä¸šåŠ¡æ•°æ®ã€ç¼“å­˜éƒ½åœ¨å †ä¸­

4ï¼‰â€œè°ƒä¼˜æ—¶ä¼˜å…ˆå…³æ³¨å †å†…å­˜ï¼Œæ ˆå†…å­˜é€šå¸¸ä¸æ˜¯ç“¶é¢ˆâ€
é™¤éæœ‰æ·±åº¦é€’å½’æˆ–å¤§é‡çº¿ç¨‹

5ï¼‰â€œæ ˆæº¢å‡ºå®¹æ˜“å‘ç°ï¼ˆStackOverflowErrorï¼‰ï¼Œå †æº¢å‡ºæ›´å¸¸è§ï¼ˆOOMï¼‰â€
ç”Ÿäº§ç¯å¢ƒæ›´å¤šå¤„ç†å †å†…å­˜é—®é¢˜

è®°ä½è¿™ä¸ªç»“è®ºï¼šåœ¨ç»å¤§å¤šæ•°Javaåº”ç”¨ä¸­ï¼Œå †å†…å­˜è¿œå¤§äºæ ˆå†…å­˜ã€‚æ ˆå†…å­˜é€šå¸¸åªå æ€»å†…å­˜çš„å¾ˆå°ä¸€éƒ¨åˆ†ï¼ˆ<10%ï¼‰ï¼Œé™¤éåº”ç”¨åˆ›å»ºäº†å¤§é‡çº¿ç¨‹æˆ–ä½¿ç”¨äº†æ·±åº¦é€’å½’ã€‚


1.8 String / StringBuilder / StringBuffer
| ç±»å‹            | é€‚ç”¨åœºæ™¯       | æ³¨æ„         |
| ------------- | ---------- | ---------- |
| String        | å°‘é‡æ‹¼æ¥ã€ä¸é¢‘ç¹ä¿®æ”¹ | æ˜“è¯»ã€ç®€å•      |
| StringBuilder | å¾ªç¯æ‹¼æ¥ã€åŠ¨æ€ä¿®æ”¹  | éçº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½é«˜  |
| StringBuffer  | å¤šçº¿ç¨‹æ‹¼æ¥      | åŒæ­¥å¼€é”€å¤§ï¼Œæ€§èƒ½ç¨ä½ |

å£è¯€ï¼š
å°‘é‡æ‹¼æ¥ç”¨ Stringï¼Œå¤§é‡åŠ¨æ€æ‹¼æ¥ç”¨ StringBuilderï¼›å¤šçº¿ç¨‹å…±äº«ç”¨ StringBuffer

ä¸ºä»€ä¹ˆ StringBuilder çº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ
StringBuilder çš„æ–¹æ³•ï¼ˆå¦‚ appendã€insertï¼‰æ²¡æœ‰åŠ  synchronized
å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ª StringBuilder å¯¹è±¡ï¼Œä¼šå‡ºç° æ•°æ®ç«æ€ï¼ˆrace conditionï¼‰
ä¾‹å¦‚æ‹¼æ¥é”™ä¹±ã€å­—ç¬¦ä¸¢å¤±ã€æ•°ç»„è¶Šç•Œ

StringBuffer æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼šå®ƒçš„å…³é”®æ–¹æ³•éƒ½åŠ äº† synchronized

1.9 
æ•°ç»„ï¼š int[] array = new int[5]; å›ºå®šå¤§å°
åˆ—è¡¨ï¼šList<String> arrayList = new ArrayList<>(); åŠ¨æ€æ•°ç»„ï¼Œå¯å˜å¤§å°ã€‚
é›†åˆï¼ˆSetsï¼‰ï¼šSet<String> hashSet = new HashSet<>(); ç”¨äºå­˜å‚¨ä¸é‡å¤çš„å…ƒç´ 

HashMapï¼š
HashMap<Integer, String> employeeMap = new HashMap<>();

// æ”¾å…¥æ•°æ®ï¼ˆputæ–¹æ³•ï¼‰
employeeMap.put(1001, "å¼ ä¸‰");
employeeMap.put(1002, "æå››");
employeeMap.put(1003, "ç‹äº”");
employeeMap.put(1004, "èµµå…­");

1.10

ä½¿ç”¨çº¿ç¨‹æ± å’ŒåŸå­æ“ä½œï¼Œä¾‹å¦‚å¤šäººæŠ¢ç¥¨ç³»ç»Ÿã€‚

import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * é«˜çº§ç‰ˆ - ä½¿ç”¨çº¿ç¨‹æ± å’ŒåŸå­æ“ä½œ
 * æ›´é«˜æ•ˆã€æ›´ä¸“ä¸šçš„å¤šçº¿ç¨‹å®ç°
 */
public class ConcertTicketSystem {
    // å‰©ä½™ç¥¨æ•°ï¼ˆä½¿ç”¨åŸå­æ•´æ•°ï¼Œä¿è¯åŸå­æ€§ï¼‰
    private AtomicInteger remainingTickets = new AtomicInteger(100);
    
    // æˆåŠŸæŠ¢åˆ°ç¥¨çš„ç”¨æˆ·åˆ—è¡¨ï¼ˆçº¿ç¨‹å®‰å…¨çš„é›†åˆï¼‰
    private ConcurrentLinkedQueue<String> successBuyers = new ConcurrentLinkedQueue<>();
    
    // å–ç¥¨æ–¹æ³• - ä½¿ç”¨åŸå­æ“ä½œ
    public boolean tryBuyTicket(String buyerName) {
        // ä½¿ç”¨åŸå­æ“ä½œçš„CASï¼ˆCompare and Swapï¼‰æœºåˆ¶
        while (true) {
            int current = remainingTickets.get();
            if (current <= 0) {
                return false; // ç¥¨å·²å”®ç½„
            }
            
            // CASæ“ä½œï¼šå¦‚æœå½“å‰å€¼ä»æ˜¯currentï¼Œåˆ™å‡1
            if (remainingTickets.compareAndSet(current, current - 1)) {
                successBuyers.offer(buyerName); // è®°å½•æˆåŠŸç”¨æˆ·
                
                // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†æ—¶é—´
                try {
                    Thread.sleep(ThreadLocalRandom.current().nextInt(5, 15));
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
                
                System.out.printf("[%s] %s æˆåŠŸæŠ¢åˆ°ç¥¨ï¼Œå‰©ä½™ç¥¨æ•°: %d%n",
                        Thread.currentThread().getName(),
                        buyerName,
                        current - 1);
                return true;
            }
            // å¦‚æœCASå¤±è´¥ï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‡è¯•
        }
    }
    
    public static void main(String[] args) throws InterruptedException {
        ConcertTicketSystem ticketSystem = new ConcertTicketSystem();
        
        System.out.println("ğŸµ çƒ­é—¨æ¼”å”±ä¼šé—¨ç¥¨å¼€å”®ï¼ ğŸµ");
        System.out.println("æ€»ç¥¨æ•°: 100 å¼ ");
        System.out.println("æŠ¢ç¥¨äººæ•°: 1000 äºº");
        System.out.println("=".repeat(50));
        
        // åˆ›å»ºçº¿ç¨‹æ± ï¼ˆæœ€ä½³å®è·µï¼šä¸è¦ç›´æ¥new Threadï¼‰
        int coreCount = Runtime.getRuntime().availableProcessors();
        ExecutorService executor = Executors.newFixedThreadPool(coreCount * 2);
        
        // ä½¿ç”¨CountDownLatchæ§åˆ¶å¹¶å‘
        CountDownLatch latch = new CountDownLatch(1000);
        
        // è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        // æäº¤1000ä¸ªæŠ¢ç¥¨ä»»åŠ¡
        for (int i = 1; i <= 1000; i++) {
            final int userId = i;
            executor.submit(() -> {
                try {
                    String buyerName = "ç”¨æˆ·" + userId;
                    ticketSystem.tryBuyTicket(buyerName);
                } finally {
                    latch.countDown(); // ä»»åŠ¡å®Œæˆ
                }
            });
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        latch.await();
        
        // å…³é—­çº¿ç¨‹æ± 
        executor.shutdown();
        executor.awaitTermination(1, TimeUnit.MINUTES);
        
        long endTime = System.currentTimeMillis();
        
        // æ‰“å°ç»Ÿè®¡ç»“æœ
        System.out.println("\n" + "=".repeat(50));
        System.out.println("ğŸ‰ æŠ¢ç¥¨ç»Ÿè®¡ç»“æœ ğŸ‰");
        System.out.println("æ€»è€—æ—¶: " + (endTime - startTime) + "ms");
        System.out.println("æˆåŠŸæŠ¢åˆ°ç¥¨çš„ç”¨æˆ·æ•°: " + ticketSystem.successBuyers.size());
        System.out.println("å‰©ä½™ç¥¨æ•°: " + ticketSystem.remainingTickets.get());
        
        // æ˜¾ç¤ºå‰10ä¸ªæŠ¢åˆ°ç¥¨çš„ç”¨æˆ·
        System.out.println("\nğŸ† å‰10ä½æŠ¢åˆ°ç¥¨çš„ç”¨æˆ·:");
        int count = 0;
        for (String buyer : ticketSystem.successBuyers) {
            if (count++ < 10) {
                System.out.println("  " + buyer);
            } else {
                break;
            }
        }
    }
}



2. å­¦ä¹  Spring Core å’Œ DI/AOP æ¦‚å¿µ
â“ ä¸ºä»€ä¹ˆä¸ç”¨ newï¼Ÿ


æ–¹é¢	ä½¿ç”¨ new	ä½¿ç”¨ Spring DI	ä¼˜åŠ¿
åˆ›å»ºæ§åˆ¶	è‡ªå·±æ§åˆ¶	å®¹å™¨æ§åˆ¶	âœ… è§£è€¦
ä¾èµ–ç®¡ç†	æ‰‹åŠ¨ç®¡ç†	è‡ªåŠ¨ç®¡ç†	âœ… ç®€å•
å•ä¾‹æ¨¡å¼	è‡ªå·±å®ç°	è‡ªåŠ¨å•ä¾‹	âœ… ç»Ÿä¸€
å¾ªç¯ä¾èµ–	éš¾å¤„ç†	è‡ªåŠ¨æ£€æµ‹	âœ… å®‰å…¨
æµ‹è¯•	éœ€è¦Mock	è½»æ¾æ³¨å…¥Mock	âœ… å¯æµ‹è¯•
é…ç½®å˜æ›´	æ”¹ä»£ç 	æ”¹é…ç½®	âœ… çµæ´»


å¯åŠ¨æ—¶é—´ vs è¿è¡Œæ—¶é—´
ä½¿ç”¨ newï¼š
âœ… å¯åŠ¨å¿«ï¼šç›´æ¥åˆ›å»º
âŒ è¿è¡Œæ…¢ï¼šæ¯æ¬¡éƒ½è¦åˆ›å»ºå’Œè¿æ¥

ä½¿ç”¨ Spring DIï¼š
âŒ å¯åŠ¨æ…¢ï¼šéœ€è¦æ‰«æã€åˆ†æã€åˆ›å»ºæ‰€æœ‰Bean
âœ… è¿è¡Œå¿«ï¼šBeanæ˜¯å•ä¾‹ï¼Œå¤ç”¨å·²åˆ›å»ºçš„å¯¹è±¡

å¯¹äºé•¿æœŸè¿è¡Œçš„æœåŠ¡ï¼ˆå¦‚WebæœåŠ¡å™¨ï¼‰ï¼š
å¯åŠ¨æ—¶é—´å½±å“ä¸å¤§ï¼Œè¿è¡Œæ•ˆç‡æ›´é‡è¦ï¼

â“ å¯¹è±¡æ˜¯è°åˆ›å»ºçš„ï¼Ÿ
å¯¹è±¡æ˜¯ç”± Spring IoCï¼ˆæ§åˆ¶åè½¬ï¼‰å®¹å™¨åˆ›å»ºçš„ã€‚

â“ Spring å®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ
Springå®¹å™¨ï¼ˆIoCå®¹å™¨ï¼‰æ˜¯Springæ¡†æ¶çš„æ ¸å¿ƒå¼•æ“ï¼Œå®ƒçš„æ­£å¼åç§°æ˜¯ ApplicationContextï¼ˆåº”ç”¨ä¸Šä¸‹æ–‡ï¼‰ã€‚

åˆ›å»ºå¹¶ç®¡ç†æ‰€æœ‰ç”±å®ƒæ‰˜ç®¡çš„Javaå¯¹è±¡ï¼ˆè¿™äº›å¯¹è±¡è¢«ç§°ä¸º Beanï¼‰ã€‚
è®°ä½ï¼šåœ¨ Spring çš„ä¸–ç•Œé‡Œï¼Œå‡ ä¹ä¸€åˆ‡å¯¹è±¡éƒ½æ˜¯ Beanï¼

æœ¬è´¨ä¸€å¥è¯ï¼š
Spring å¸®ä½ ç®¡ç†å¯¹è±¡çš„åˆ›å»ºã€ä¾èµ–å…³ç³»å’Œç”Ÿå‘½å‘¨æœŸ

3. å®è·µ Spring MVC å¼€å‘ Web åº”ç”¨
3.1 è¦å­¦ä¹  Java 1.8ï¼ˆJava 8ï¼‰+ Spring Boot 2.7.6ï¼Œå®˜æ–¹å·²ç»ä¸æ¨èäº†ã€‚æ‰€ä»¥è¦æ‰‹åŠ¨åœ¨ https://start.aliyun.com/ è¿›è¡Œä¸‹è½½ Srping Boot 2.7.6ã€‚

â‘  åŠ  JPA + MySQL ä¾èµ–
â‘¡ é…ç½®æ•°æ®æº
â‘¢ å†™ UserEntity
â‘£ å†™ UserRepository
â‘¤ å†™ UserService
â‘¥ Controller è°ƒæ¥å£


4. å­¦ä¹  Spring Data è¿›è¡Œæ•°æ®åº“æ“ä½œ

5. æŒæ¡ Spring Boot ç®€åŒ–å¼€å‘æµç¨‹
Spring Boot æ˜¯ Spring æ¡†æ¶çš„æ‰©å±•ï¼Œæ—¨åœ¨ç®€åŒ– Spring åº”ç”¨çš„åˆå§‹æ­å»ºå’Œå¼€å‘è¿‡ç¨‹ã€‚

Spring Boot ä¸»è¦ç‰¹æ€§ï¼š

è‡ªåŠ¨é…ç½®ï¼šæ ¹æ®ç±»è·¯å¾„ä¸­çš„ jar åŒ…è‡ªåŠ¨é…ç½® Spring åº”ç”¨
èµ·æ­¥ä¾èµ–ï¼šç®€åŒ–ä¾èµ–ç®¡ç†
å†…åµŒæœåŠ¡å™¨ï¼šæ— éœ€éƒ¨ç½² WAR æ–‡ä»¶
Actuatorï¼šæä¾›ç”Ÿäº§çº§ç›‘æ§åŠŸèƒ½

6. æ¢ç´¢ Spring Cloud æ„å»ºå¾®æœåŠ¡
6.1 Spring Cloud vs Spring Boot
Spring Bootï¼šç®€åŒ–å•ä¸ªåº”ç”¨çš„å¼€å‘
Spring Cloudï¼šæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿ/å¾®æœåŠ¡æ¶æ„ï¼Œå…³æ³¨å¦‚ä½•è¿æ¥å’Œç®¡ç†å¤šä¸ªSpring Bootåº”ç”¨

1ã€ **å…ˆæŒæ¡ Spring Boot**ï¼ˆå¿…é¡»ï¼‰
   - è‡ªåŠ¨é…ç½®åŸç†
   - Starteræœºåˆ¶
   - REST APIå¼€å‘
   - æ•°æ®è®¿é—®ï¼ˆJPA/MyBatisï¼‰
   - äº‹åŠ¡ç®¡ç†

2ã€ **å†å­¦ä¹  Spring Cloud**ï¼ˆéœ€è¦æ—¶ï¼‰
   - å…ˆç†è§£å¾®æœåŠ¡æ¦‚å¿µ
   - ä»æœåŠ¡æ³¨å†Œå‘ç°å¼€å§‹ï¼ˆEureka/Nacosï¼‰
   - å­¦ä¹ æœåŠ¡é—´é€šä¿¡ï¼ˆFeign/RestTemplateï¼‰
   - æŒæ¡é…ç½®ä¸­å¿ƒï¼ˆConfig/Nacosï¼‰
   - äº†è§£ç†”æ–­é™æµï¼ˆHystrix/Sentinelï¼‰


// é—®ï¼šæˆ‘åº”è¯¥ç›´æ¥å­¦Spring Cloudå—ï¼Ÿ
// ç­”ï¼šä¸å»ºè®®ï¼åº”è¯¥ï¼š

// é˜¶æ®µ1ï¼šæŒæ¡å•ä½“åº”ç”¨å¼€å‘ï¼ˆSpring Bootè¶³å¤Ÿï¼‰
@SpringBootApplication
public class MonolithApplication {
    // ç”¨æˆ·ç®¡ç†ã€è®¢å•ç®¡ç†éƒ½åœ¨ä¸€ä¸ªåº”ç”¨é‡Œ
    // ä½¿ç”¨Spring MVC + Spring Data + Spring Security
}

// é˜¶æ®µ2ï¼šå­¦ä¹ å¾®æœåŠ¡æ‹†åˆ†ï¼ˆéœ€è¦Spring Cloudï¼‰
// æŠŠä¸Šé¢çš„å•ä½“æ‹†åˆ†ä¸ºï¼š
// 1. user-serviceï¼ˆç”¨æˆ·æœåŠ¡ï¼‰
// 2. order-serviceï¼ˆè®¢å•æœåŠ¡ï¼‰
// 3. product-serviceï¼ˆå•†å“æœåŠ¡ï¼‰
// 4. ç”¨Spring CloudæŠŠå®ƒä»¬è¿æ¥èµ·æ¥


-------------------------------
-------------------------------
-------------------------------
-------------------------------
-------------------------------
-------------------------------
7. ç»ƒæ‰‹
è·³æ§½ç”¨æœ€å°é¡¹ç›®ï¼ˆå¿…åšï¼‰

â— ä¸åšé¡¹ç›® = å¾ˆéš¾è¯´æœé¢è¯•å®˜

é¡¹ç›®ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰

ä¸€ä¸ªå¸¦ JWT ç™»å½•çš„ Spring Boot API æœåŠ¡

é¡¹ç›®åŠŸèƒ½ï¼ˆåˆšåˆšå¥½ï¼Œä¸å¤šï¼‰
POST   /api/auth/login
GET    /api/users
GET    /api/users/{id}
POST   /api/users
PUT    /api/users/{id}
DELETE /api/users/{id}

æŠ€æœ¯ç‚¹ï¼ˆå…¨æ˜¯é¢è¯•ç‚¹ï¼‰

Java 17
1ï¼‰Sealed Classesï¼ˆå¯†å°ç±»ï¼‰ï¼šé™åˆ¶å“ªäº›ç±»å¯ä»¥é›†æˆï¼Œå¢å¼ºä»£ç å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§
2ï¼‰Recordsï¼ˆè®°å½•ç±»ï¼‰ï¼šè‡ªåŠ¨ç”Ÿæˆæ„é€ å‡½æ•°ã€getterï¼Œç±»ä¼¼ Lombok @Dataã€‚è§£å†³æ ·æ¿ä»£ç å¤šçš„é—®é¢˜ã€‚
3ï¼‰Switchè¡¨è¾¾å¼ï¼šè§£å†³Switchè¯­å¥å†—é•¿
4ï¼‰Text Blocksï¼ˆæ–‡æœ¬å—ï¼‰- JEP 378
java
// é¢è¯•é—®é¢˜ï¼šText Blocks è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
// æ—§æ–¹å¼ï¼šå¤šè¡Œå­—ç¬¦ä¸²æ‹¼æ¥ä¸‘
String json = "{\n" +
              "  \"name\": \"å¼ ä¸‰\",\n" +
              "  \"age\": 25\n" +
              "}";

// Java 17 æ–¹å¼ï¼šä¸‰å¼•å·æ–‡æœ¬å—
String json = """
    {
      "name": "å¼ ä¸‰",
      "age": 25
    }
    """;


Spring Boot

Spring Data JPA æˆ– MyBatis

JWTï¼ˆæ‹¦æˆªå™¨å®ç°ï¼‰

AOP æ—¥å¿—
Spring Boot 2 æœ€å¸¸ç”¨çš„æ—¥å¿—æ–¹æ¡ˆï¼Œæœ€å¸¸ç”¨ç»„åˆï¼šSLF4J + Logbackï¼Œå¦å¤–å†åŠ ä¸ŠLombok ä¾èµ–/æ³¨è§£

SLF4J (Simple Logging Facade for Java)

æ¦‚å¿µ	ç±»æ¯”	è¯´æ˜
SLF4J	Java çš„ JDBC æ¥å£	å®šä¹‰äº†ä¸€ç»„æ ‡å‡†æ¥å£ï¼Œä½†ä¸å®ç°
Logback	MySQL JDBC é©±åŠ¨	å…·ä½“çš„å®ç°ï¼ŒçœŸæ­£å¹²æ´»çš„éƒ¨åˆ†
å…³ç³»	USB æ¥å£ vs USB è®¾å¤‡	SLF4J æ˜¯æ¥å£è§„èŒƒï¼ŒLogback æ˜¯å…·ä½“è®¾å¤‡

å¦å¤–å¯ä»¥åŠ ä¸Šæ·»åŠ  Lombok ä¾èµ–ï¼ˆæœ€å¸¸ç”¨ï¼‰
<!-- Lombokï¼šæ³¨è§£è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œå¦‚@Getterã€@Setterã€@Slf4jã€@Builder -->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.30</version> <!-- ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ -->
    <scope>provided</scope>
</dependency>



------------------------------
------------------------------
Controllerçš„åˆ‡é¢ä¾‹å­ï¼Œç”¨æ¥è®°å½•requestå’Œresponseã€è€—æ—¶ï¼š

package com.muwen.demoapi.web.aspect;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.*;
import org.springframework.stereotype.Component;

@Slf4j // ç›¸å½“äº private static final Logger log = LoggerFactory.getLogger(WebLogAspect.class);
@Aspect // å‘Šè¯‰ Spring è¿™æ˜¯ä¸€ä¸ªåˆ‡é¢ç±»ï¼ŒåŒ…å«åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰å’Œé€šçŸ¥ï¼ˆAdviceï¼‰ã€‚æ²¡æœ‰ @Aspectï¼Œåˆ™@Pointcutã€@Beforeã€@Around ç­‰æ³¨è§£æ— æ•ˆ
@Component // è®© Spring æ‰«æåˆ°è¯¥ç±»å¹¶æ³¨å†Œä¸º Beanï¼Œè®© Spring å®¹å™¨åˆ›å»ºå’Œç®¡ç†è¯¥ç±»çš„å®ä¾‹
public class WebLogAspect {
    private final ObjectMapper objectMapper;

    public WebLogAspect(ObjectMapper objectMapper) {
        this.objectMapper = objectMapper;
    }

    @Pointcut("execution(public * com.muwen.demoapi.web.controller..*(..))")
    public void webLogPointcut() {}

    /**
     * å‰ç½®é€šçŸ¥ï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œ
     *
     * @param joinPoint åˆ‡ç‚¹
     */
    @Before("webLogPointcut()")
    public void doBefore(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().toShortString();
        Object[] args = joinPoint.getArgs();
        log.info("è¯·æ±‚æ–¹æ³•: {}, å‚æ•°: {}", methodName, args);
    }

    /**
     * ç¯ç»•é€šçŸ¥ï¼šç¯ç»•ç›®æ ‡æ–¹æ³•æ‰§è¡Œ
     *
     * @param proceedingJoinPoint åˆ‡ç‚¹
     * @return ç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼
     * @throws Throwable å¦‚æœç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸
     */
    @Around("webLogPointcut()")
    public Object doAround(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();

        Object result = proceedingJoinPoint.proceed();

        // è¾“å‡ºæ‰§è¡Œæ—¶é—´
        log.info("Time Consuming: {} ms", System.currentTimeMillis() - startTime);

        return result;
    }

    /**
     * åç½®é€šçŸ¥ï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œåæ‰§è¡Œ
     *
     * @param result ç›®æ ‡æ–¹æ³•çš„è¿”å›å€¼
     */
    @AfterReturning(pointcut = "webLogPointcut()", returning = "result")
    public void doAfterReturning(Object result) {
        try {
            String responseBody = objectMapper.writeValueAsString(result);
            log.info("å“åº”ç»“æœ: {}", responseBody);
        } catch (JsonProcessingException e) {
            log.warn("å“åº”ç»“æœåºåˆ—åŒ–å¤±è´¥", e);
            log.info("å“åº”ç»“æœ: {}", result);
        }
    }


}

------------------------------
------------------------------



äº‹åŠ¡

Dockerï¼ˆåŠ åˆ†ï¼‰

ğŸ‘‰ è¿™ä¸ªé¡¹ç›® = é¢è¯•å¼¹è¯åº“



ä¸­å›½ Java é¢è¯•é«˜é¢‘å…«è‚¡ï¼ˆåªèƒŒè¿™äº›ï¼‰
ğŸ”¥ å¿…ä¼š

Spring IoC / DI

AOP åŸç†
ä¸€å¥è¯æ¦‚æ‹¬ï¼šSpring AOP æ˜¯åŸºäºåŠ¨æ€ä»£ç†å®ç°çš„ï¼Œç”¨äºå°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—ã€äº‹åŠ¡ï¼‰æ¨¡å—åŒ–ï¼Œå¹¶ä»¥éä¾µå…¥æ–¹å¼ç»‡å…¥åˆ°ç›®æ ‡æ–¹æ³•çš„æ¡†æ¶ã€‚

1ï¼‰Spring AOP å’Œ AspectJ æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
Spring AOP æ˜¯è¿è¡Œæ—¶åŠ¨æ€ä»£ç†ï¼Œä»…æ”¯æŒæ–¹æ³•çº§åˆ«çš„ç»‡å…¥ã€‚
AspectJ æ˜¯ç¼–è¯‘æ—¶/ç±»åŠ è½½ç»‡å…¥ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼ˆå¯ç»‡å…¥å­—æ®µã€æ„é€ å™¨ç­‰ï¼‰ï¼Œä½†æ›´å¤æ‚ã€‚

Spring AOPæ˜¯AspectJçš„ä¸€ä¸ªåŠŸèƒ½å­é›†ã€‚

2ï¼‰é€šçŸ¥çš„é¡ºåºï¼š
@Around å¼€å§‹ï¼ˆproceed() ä¹‹å‰çš„éƒ¨åˆ†ï¼‰
@Before
proceed()ç›®æ ‡æ–¹æ³•æ‰§è¡Œ
@Around ç»§ç»­ï¼ˆproceed() ä¹‹åçš„éƒ¨åˆ†ï¼‰
@AfterReturningï¼ˆæˆåŠŸï¼‰æˆ– @AfterThrowingï¼ˆå¼‚å¸¸ï¼‰
@Afterï¼ˆæœ€ç»ˆé€šçŸ¥ï¼Œç±»ä¼¼ finallyï¼‰

3ï¼‰Spring AOP é»˜è®¤ä½¿ç”¨å“ªç§åŠ¨æ€ä»£ç†ï¼Ÿåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ CGLIBï¼Ÿ
é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœç›®æ ‡ç±»å®ç°äº†è‡³å°‘ä¸€ä¸ªæ¥å£ï¼ŒSpring AOP ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼ˆåŸºäº InvocationHandlerï¼‰ï¼›å¦‚æœç›®æ ‡ç±»æ²¡æœ‰å®ç°æ¥å£ï¼Œåˆ™ä½¿ç”¨ CGLIB ç”Ÿæˆå­ç±»ä»£ç†ã€‚åœ¨ Spring Boot 2.x åï¼Œå¯ä»¥é€šè¿‡ spring.aop.proxy-target-class=true å¼ºåˆ¶ä½¿ç”¨ CGLIBã€‚

JDKåŠ¨æ€ä»£ç†åŸºäºæ¥å£ï¼Œåˆ©ç”¨åå°„æœºåˆ¶ï¼›CGLIBåŸºäºç»§æ‰¿ï¼Œé€šè¿‡å­—èŠ‚ç ç”Ÿæˆå­ç±»ã€‚

4ï¼‰å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ³¨è§£ï¼Œå¹¶åˆ©ç”¨ AOP ä½¿å…¶ç”Ÿæ•ˆï¼Ÿ
å®šä¹‰æ³¨è§£ @MyLogã€‚
åˆ›å»ºåˆ‡é¢ç±»ï¼Œç”¨ @Aspect å’Œ @Component æ ‡æ³¨ã€‚
åœ¨é€šçŸ¥æ³¨è§£ï¼ˆå¦‚ @Aroundï¼‰ä¸­ï¼Œä½¿ç”¨ @annotation(myLog) ç»‘å®šè‡ªå®šä¹‰æ³¨è§£ã€‚
åœ¨é€šçŸ¥æ–¹æ³•ä¸­ç¼–å†™å¢å¼ºé€»è¾‘ã€‚

5ï¼‰åœ¨å¾®æœåŠ¡ä¸­ï¼ŒAOP å¯ä»¥åº”ç”¨äºå“ªäº›åœºæ™¯ï¼Ÿ
å…¨å±€å¼‚å¸¸å¤„ç†ï¼š@ControllerAdvice æœ¬èº«å°±æ˜¯ AOP æ€æƒ³çš„ä½“ç°ã€‚
åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼šåœ¨åˆ‡é¢ä¸­å‘è¯·æ±‚å¤´æ³¨å…¥æˆ–æå– TraceIdã€‚
æ¥å£é™æµä¸ç†”æ–­ï¼šé€šè¿‡è‡ªå®šä¹‰æ³¨è§£å’Œ AOP ç»Ÿä¸€å®ç°ã€‚
Feign å®¢æˆ·ç«¯å¢å¼ºï¼šç»Ÿä¸€æ·»åŠ è®¤è¯å¤´ã€è®°å½•æ—¥å¿—ã€‚

6ï¼‰AOP å¯¹æ€§èƒ½æœ‰å½±å“å—ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ
å½±å“ï¼šåŠ¨æ€ä»£ç†ä¼šå¸¦æ¥å¾®å°çš„æ€§èƒ½å¼€é”€ï¼ˆæ–¹æ³•è°ƒç”¨è½¬å‘ï¼‰ã€‚

ä¼˜åŒ–ï¼šç²¾ç¡®åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼ˆé¿å…è¿‡äºå®½æ³›çš„ execution(* com..*.*(..))ï¼‰ï¼Œåœ¨éå¿…è¦çš„åœ°æ–¹é¿å…ä½¿ç”¨ AOPï¼Œå¯¹äºæ€§èƒ½æåº¦æ•æ„Ÿçš„åœºæ™¯å¯ä»¥è€ƒè™‘ AspectJ ç¼–è¯‘æ—¶ç»‡å…¥ã€‚

7ï¼‰ä½ åœ¨é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä½¿ç”¨ AOP è§£å†³å®é™…é—®é¢˜çš„ï¼Ÿ
æˆ‘åœ¨XXé¡¹ç›®ä¸­ï¼Œåˆ©ç”¨è‡ªå®šä¹‰æ³¨è§£ @OperationLog å’Œ AOP å®ç°äº†æ“ä½œæ—¥å¿—çš„ç»Ÿä¸€è®°å½•ã€‚åˆ‡é¢ä¼šæ‹¦æˆªæ‰€æœ‰å¸¦è¯¥æ³¨è§£çš„æ–¹æ³•ï¼Œè‡ªåŠ¨å°†æ“ä½œäººã€æ—¶é—´ã€å‚æ•°å’Œç»“æœå¼‚æ­¥å­˜å…¥æ•°æ®åº“ã€‚è¿™ä½¿ä¸šåŠ¡ä»£ç éå¸¸å¹²å‡€ï¼Œå¹¶ä¸”ä¾¿äºåç»­çš„å®¡è®¡å’Œæ’æŸ¥é—®é¢˜ã€‚
       

@Transactional å¤±æ•ˆåœºæ™¯
1ï¼‰æ–¹æ³•è®¿é—®æƒé™é—®é¢˜
    // âœ… æ­£ç¡®ï¼špublicæ–¹æ³•
    @Transactional
    public void createUserPublic(User user) {
        userRepository.save(user);
    }

2ï¼‰è‡ªè°ƒç”¨é—®é¢˜
@Service
public class OrderService {
    
    public void createOrder(Order order) {
        // âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨åŒç±»ä¸­çš„äº‹åŠ¡æ–¹æ³•
        this.updateInventory(order);  // äº‹åŠ¡å¤±æ•ˆï¼
        orderRepository.save(order);
    }
    
    @Transactional
    public void updateInventory(Order order) {
        inventoryService.reduce(order.getProductId(), order.getQuantity());
    }
}


è§£å†³æ–¹æ¡ˆï¼š
@Service
public class OrderService {
    
    // âœ… æ–¹æ¡ˆ1ï¼šæ³¨å…¥è‡ªèº«ä»£ç†
    @Autowired
    private OrderService self;  // Springä¼šæ³¨å…¥ä»£ç†å¯¹è±¡
    
    public void createOrder(Order order) {
        self.updateInventory(order);  // âœ… é€šè¿‡ä»£ç†è°ƒç”¨
        orderRepository.save(order);
    }
    
    @Transactional
    public void updateInventory(Order order) {
        inventoryService.reduce(order.getProductId(), order.getQuantity());
    }
}

ä½ æ³¨å…¥çš„ä¸æ˜¯â€œè‡ªå·±â€ï¼Œè€Œæ˜¯â€œè‡ªå·±çš„ä»£ç†â€ã€‚
AOPï¼ˆäº‹åŠ¡ï¼‰çš„é€»è¾‘æ˜¯ç”±ä»£ç†å¯¹è±¡æ‰§è¡Œçš„ã€‚

3ï¼‰å¼‚å¸¸ç±»å‹æ•è·é—®é¢˜
@Service
public class PaymentService {
    
    @Transactional
    public void processPayment(Payment payment) {
        try {
            paymentRepository.save(payment);
            throw new RuntimeException("ä¸šåŠ¡å¼‚å¸¸");
        } catch (Exception e) {
            // âŒ æ•è·äº†å¼‚å¸¸ï¼Œäº‹åŠ¡ä¸ä¼šå›æ»š
            log.error("æ”¯ä»˜å¤±è´¥", e);
        }
    }
    
    @Transactional
    public void processPayment2(Payment payment) {
        try {
            paymentRepository.save(payment);
            throw new Exception("å—æ£€å¼‚å¸¸");
        } catch (Exception e) {
            // âŒ RuntimeExceptionæ‰ä¼šé»˜è®¤å›æ»šï¼Œå—æ£€å¼‚å¸¸ä¸ä¼š
            log.error("æ”¯ä»˜å¤±è´¥", e);
        }
    }
}


ä¸€ä¸ªäº‹åŠ¡ä¾‹å­ï¼š
@Service
public class PaymentService {
    
    @Transactional
    public void processPayment(PaymentRequest request) {
        // 1. ä¿å­˜æ”¯ä»˜è®°å½•ï¼ˆINSERTæ“ä½œï¼‰
        paymentRepository.save(request.toPayment());
        
        // 2. ä¸šåŠ¡é€»è¾‘å¯èƒ½æŠ›å‡ºå„ç§å¼‚å¸¸
        if (request.isInvalid()) {
            throw new IllegalArgumentException("éæ³•è¯·æ±‚"); // âœ… RuntimeExceptionï¼Œè§¦å‘å›æ»š
        }
        
        try {
            thirdPartyService.call(); // å¯èƒ½æŠ›å‡ºIOExceptionï¼ˆéRuntimeExceptionï¼‰
        } catch (IOException e) {
            // âŒ é»˜è®¤ä¸ä¼šå›æ»šï¼æ”¯ä»˜è®°å½•å·²ä¿å­˜ï¼
            throw new RuntimeException("è°ƒç”¨å¤±è´¥", e); // åŒ…è£…ä¸ºRuntimeExceptionï¼Œè§¦å‘å›æ»š
        }
        
        // 3. æ‰‹åŠ¨æ§åˆ¶å›æ»š
        if (paymentFailed) {
            TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); // æ ‡è®°å›æ»š
            // æˆ–è€…ï¼Œç›´æ¥æŠ›å‡ºç‰¹å®šå¼‚å¸¸ï¼š
            throw new CustomBusinessException("ä¸šåŠ¡å¤±è´¥ï¼Œå·²å›æ»š");
        }
    }
}

äº‹åŠ¡å¼‚å¸¸ï¼Œä¼šæŠ›å‡º RuntimeExceptionï¼Œä¾‹å¦‚ DataIntegrityViolationExceptionï¼Œå…·ä½“å¦‚ä¸‹ï¼š
[æ•°æ®åº“æ“ä½œå¤±è´¥ / ä¸šåŠ¡è§„åˆ™è¿ä¾‹]
         â†“ (æŠ›å‡º RuntimeExceptionï¼Œä¾‹å¦‚ DataIntegrityViolationException)
[Serviceå±‚ @Transactional æ–¹æ³•] â†’ äº‹åŠ¡å›æ»š
         â†“ (å¼‚å¸¸ç»§ç»­å‘ä¸ŠæŠ›å‡º)
[Controllerå±‚æ–¹æ³•]
         â†“
[å¼€å‘è€…/å‰ç«¯çœ‹åˆ°çš„ç»“æœ] â† å–å†³äºï¼š1. æ˜¯å¦å¤„ç†å¼‚å¸¸ 2. å¦‚ä½•å¤„ç†


@Transactional æ˜¯ AOPï¼Œæ˜¯å› ä¸ºå®ƒå®Œå…¨éµå¾ª AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰çš„æ ¸å¿ƒæ€æƒ³å’Œå·¥ä½œåŸç†ï¼šé€šè¿‡åŠ¨æ€ä»£ç†ï¼Œå°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆäº‹åŠ¡ç®¡ç†ï¼‰ ä»æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œå¹¶ä»¥éä¾µå…¥çš„æ–¹å¼åŠ¨æ€ç»‡å…¥ã€‚


HashMap åŸç†
é—®é¢˜1ï¼šHashMapçš„åº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿ
Java 8+ï¼šæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘

å…³é”®å‚æ•°ï¼š
é»˜è®¤åˆå§‹å®¹é‡ï¼š16
è´Ÿè½½å› å­ï¼š0.75
æ ‘åŒ–é˜ˆå€¼ï¼šé“¾è¡¨é•¿åº¦â‰¥8 ä¸” æ•°ç»„é•¿åº¦â‰¥64æ—¶ï¼Œé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘
é€€åŒ–é˜ˆå€¼ï¼šæ ‘èŠ‚ç‚¹â‰¤6ï¼Œçº¢é»‘æ ‘é€€åŒ–ä¸ºé“¾è¡¨

æ˜¯çš„ï¼Œæ‚¨è¯´å¾—å¯¹ã€‚åœ¨æ­£å¸¸çš„ä¸šåŠ¡æ•°æ®å’Œè‰¯å¥½çš„å“ˆå¸Œå‡½æ•°ä¸‹ï¼ŒHashMapå‡ ä¹ä¸ä¼šè§¦å‘çº¢é»‘æ ‘è½¬æ¢ï¼Œæ ¹æ®æ³Šæ¾åˆ†å¸ƒï¼Œé“¾è¡¨é•¿åº¦è¾¾åˆ°8çš„æ¦‚ç‡åªæœ‰çº¦ä¸€äº¿åˆ†ä¹‹å…­ã€‚

ä½†JDKå¼•å…¥çº¢é»‘æ ‘æœºåˆ¶ä¸»è¦æ˜¯ä¸€ç§é˜²å¾¡æ€§ç¼–ç¨‹ç­–ç•¥ï¼Œæ ¸å¿ƒç›®çš„æ˜¯ï¼š

é˜²æ­¢å“ˆå¸Œç¢°æ’æ”»å‡»ï¼šç¡®ä¿å³ä½¿é­é‡æ¶æ„æ”»å‡»ï¼Œæ€§èƒ½ä¹Ÿä¸ä¼šä»O(1)æ¶åŒ–ä¸ºO(n)ï¼Œè€Œæ˜¯ç»´æŒåœ¨O(log n)ã€‚

ä¸ºåŠ£è´¨hashCodeå…œåº•ï¼šå¯¹å¼€å‘è€…ä¸è§„èŒƒçš„hashCode()å®ç°æä¾›ä¸€å®šçš„æ€§èƒ½ä¿éšœã€‚

æ‰€ä»¥ï¼Œè™½ç„¶å®ƒæ˜¯ä¸€ä¸ªâ€˜å¤‡èƒâ€™ï¼Œä½†å´æ˜¯ä¿éšœHashMapåœ¨æç«¯æƒ…å†µä¸‹ä»èƒ½ä¿æŒå¯ç”¨æ€§çš„å…³é”®å®‰å…¨ç½‘ã€‚åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œç¡®ä¿ä½œä¸ºKeyçš„å¯¹è±¡æ­£ç¡®å®ç°hashCode()å’Œequals()æ–¹æ³•ï¼Œå°±æ˜¯é¿å…è§¦å‘è¿™ä¸ªâ€˜å¤‡èƒæœºåˆ¶â€™çš„æœ€ä½³å®è·µã€‚

Q1ï¼šHashMapä¸ºä»€ä¹ˆçº¿ç¨‹ä¸å®‰å…¨ï¼Ÿ
å›ç­”è¦ç‚¹ï¼š
1ï¼‰å¤šçº¿ç¨‹æ‰©å®¹æ—¶å¯èƒ½å½¢æˆå¾ªç¯é“¾è¡¨ï¼ˆJDK 1.7åŠä¹‹å‰ï¼‰ï¼Œå¯¼è‡´CPU 100%ã€‚
2ï¼‰å¤šçº¿ç¨‹putå¯èƒ½è¦†ç›–æ•°æ®ã€‚ï¼ˆä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ’å…¥æ–°èŠ‚ç‚¹ï¼Œä¼šæœ‰Bè¦†ç›–Açš„æƒ…å†µï¼‰
3ï¼‰sizeè®¡æ•°ä¸å‡†ç¡®ï¼ˆéåŸå­æ“ä½œï¼‰ã€‚ï¼ˆä¸¤ä¸ªçº¿ç¨‹æ‹¿åˆ°çš„å½“å‰size = 5ï¼Œéƒ½è®¤ä¸ºsize = 5+1 = 6ï¼Œå®é™…ä¸Šåº”è¯¥æ˜¯ 7 äº†ã€‚ï¼‰

Q2ï¼šHashMapçš„è´Ÿè½½å› å­ä¸ºä»€ä¹ˆæ˜¯0.75ï¼Ÿ
å›ç­”è¦ç‚¹ï¼š
1ï¼‰ç©ºé—´ä¸æ—¶é—´çš„æƒè¡¡ï¼š0.75åœ¨ç»Ÿè®¡å­¦ä¸Šæ˜¯æœ€ä½³å¹³è¡¡ç‚¹ã€‚
2ï¼‰æ³Šæ¾åˆ†å¸ƒï¼šé“¾è¡¨é•¿åº¦â‰¥8çš„æ¦‚ç‡æä½ï¼ˆçº¦0.00000006ï¼‰ã€‚
3ï¼‰Spring Bootåº”ç”¨ï¼šå¯ä»¥æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´ï¼Œå¦‚ç¼“å­˜å¯†é›†çš„åº”ç”¨å¯é™ä½è´Ÿè½½å› å­ã€‚

Q3ï¼šSpring Bootä¸­å¦‚ä½•æ­£ç¡®ä½¿ç”¨HashMapï¼Ÿ
å›ç­”è¦ç‚¹ï¼š

1ï¼‰ä¼˜å…ˆä½¿ç”¨ConcurrentHashMapå¤„ç†å…±äº«æ•°æ®ã€‚
2ï¼‰è€ƒè™‘ä½¿ç”¨Guava Cacheæˆ–Caffeineä½œä¸ºç¼“å­˜å®ç°ã€‚
3ï¼‰Rest APIè¿”å›æ—¶ä½¿ç”¨DTOè€Œéç›´æ¥è¿”å›HashMapã€‚
4ï¼‰é…ç½®ç±»ä¸­çš„Mapå¯ä½¿ç”¨@ConfigurationPropertiesè‡ªåŠ¨ç»‘å®šã€‚

Q4ï¼šè´Ÿè½½å› å­ä¸ºä»€ä¹ˆé»˜è®¤æ˜¯0.75ï¼Ÿ
ç©ºé—´ä¸æ—¶é—´çš„æƒè¡¡ï¼ŒèƒŒåçš„åŸç†æ˜¯æ³Šæ¾åˆ†å¸ƒï¼š
è´Ÿè½½å› å­é«˜ï¼ˆå¦‚1.0ï¼‰ï¼šç©ºé—´åˆ©ç”¨ç‡é«˜ï¼Œä½†å“ˆå¸Œå†²çªå¢åŠ ï¼ŒæŸ¥è¯¢å˜æ…¢ã€‚åƒæŒ¤æ»¡äººçš„ç”µæ¢¯ï¼Œç©ºé—´ç”¨è¶³äº†ï¼Œä½†è°éƒ½åŠ¨ä¸äº†ï¼Œæ•ˆç‡æä½ã€‚
è´Ÿè½½å› å­ä½ï¼ˆå¦‚0.5ï¼‰ï¼šå†²çªå°‘ï¼ŒæŸ¥è¯¢å¿«ï¼Œä½†ç©ºé—´æµªè´¹ï¼Œæ‰©å®¹é¢‘ç¹ã€‚åƒç©ºæ—·çš„åœè½¦åœºï¼Œåœè½¦å®¹æ˜“ï¼Œä½†åœŸåœ°é—²ç½®å¤ªå¤šï¼Œä¸ç»æµã€‚

0.75 åƒé«˜å³°æœŸçš„åœ°é“ï¼Œæœ‰ä¸€å®šæ‹¥æŒ¤ï¼Œä½†æ•´ä½“è¿è¡Œæ•ˆç‡æœ€é«˜ã€‚

Q5ï¼šå¦‚æœkeyä¸ºnullï¼Œå­˜æ”¾åœ¨å“ªé‡Œï¼Ÿ
å¦‚æœkey = nullï¼Œåˆ™ä¸º0ã€‚æ ¹æ®æºç ï¼šhash = (key == null) ? 0 : hash(key)

Q6ï¼šHashMapå’ŒConcurrentHashMapæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

å¯¹æ¯”ç»´åº¦	HashMap	ConcurrentHashMap (JDK 1.8)
çº¿ç¨‹å®‰å…¨	ä¸å®‰å…¨	å®‰å…¨
é”æœºåˆ¶	æ— é”	åˆ†æ®µé” + CAS + synchronizedï¼ˆé”å•ä¸ªæ¡¶ï¼‰
æ€§èƒ½	é«˜ï¼ˆæ— é”ï¼‰	è¾ƒé«˜ï¼ˆé”ç²’åº¦ç»†ï¼‰
è¿­ä»£å™¨	å¿«é€Ÿå¤±è´¥ (fail-fast)	å¼±ä¸€è‡´æ€§ (weakly consistent)
Nullå€¼	å…è®¸	ä¸å…è®¸é”®æˆ–å€¼ä¸ºnullï¼ˆé¿å…æ­§ä¹‰ï¼‰
ä½¿ç”¨åœºæ™¯	å•çº¿ç¨‹ã€å±€éƒ¨å˜é‡ã€åªè¯»å…±äº«	å¤šçº¿ç¨‹é«˜å¹¶å‘ç¯å¢ƒ


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MySQL ç´¢å¼•
B+Treeï¼šMySQL InnoDBé»˜è®¤ã€‚å¶å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹åªå­˜é”®ï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œæ’åºã€‚

Q1ï¼šB+Tree å¯¹æ¯” B-Tree
ç‰¹æ€§	B-Tree	B+Tree (MySQLé‡‡ç”¨)
æ•°æ®å­˜å‚¨	æ‰€æœ‰èŠ‚ç‚¹éƒ½å­˜æ•°æ®	åªæœ‰å¶å­èŠ‚ç‚¹å­˜æ•°æ®ï¼Œéå¶å­èŠ‚ç‚¹çº¯ç´¢å¼•
å¶å­èŠ‚ç‚¹	æ— é“¾è¡¨é“¾æ¥	é€šè¿‡åŒå‘é“¾è¡¨é“¾æ¥ï¼Œä¾¿äºèŒƒå›´æŸ¥è¯¢
æŸ¥è¯¢ç¨³å®šæ€§	ä¸ç¨³å®šï¼ˆæ•°æ®å¯èƒ½åœ¨ä¸­é—´èŠ‚ç‚¹æ‰¾åˆ°ï¼‰	ç¨³å®šï¼ˆå¿…é¡»åˆ°å¶å­èŠ‚ç‚¹ï¼‰
é€‚ç”¨åœºæ™¯	éšæœºæ£€ç´¢	èŒƒå›´æŸ¥è¯¢ã€æ’åºã€å…¨è¡¨æ‰«æ

Q2ï¼šèšç°‡ç´¢å¼• vs éèšç°‡ç´¢å¼•
ç»´åº¦	èšç°‡ç´¢å¼• (InnoDBä¸»é”®ç´¢å¼•)	éèšç°‡ç´¢å¼• (äºŒçº§ç´¢å¼•)
æ•°æ®å­˜å‚¨	ç´¢å¼•ä¸æ•°æ®å­˜æ”¾åœ¨ä¸€èµ·ï¼ˆå¶å­èŠ‚ç‚¹å°±æ˜¯æ•°æ®è¡Œï¼‰	å¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®å€¼ï¼Œéœ€è¦å›è¡¨æŸ¥è¯¢æ•°æ®
æ•°é‡	æ¯è¡¨ä»…ä¸€ä¸ª	å¯æœ‰å¤šä¸ª
åˆ›å»º	è‡ªåŠ¨æŒ‰ä¸»é”®åˆ›å»ºï¼Œæ— ä¸»é”®åˆ™é€‰å”¯ä¸€éç©ºåˆ—	æ‰‹åŠ¨åˆ›å»º
æ€§èƒ½	ä¸»é”®æŸ¥è¯¢æå¿«	éœ€è¦å›è¡¨ï¼Œå¯èƒ½æ…¢

Q3ï¼šæœ€å·¦å‰ç¼€åŸåˆ™

Q4ï¼šè¦†ç›–ç´¢å¼•
å®šä¹‰ï¼šæŸ¥è¯¢çš„å­—æ®µå…¨éƒ¨åŒ…å«åœ¨ç´¢å¼•ä¸­ï¼Œæ— éœ€å›è¡¨ã€‚

ç¤ºä¾‹ï¼š
-- è¡¨ user æœ‰ç´¢å¼• (name, age)
SELECT name, age FROM user WHERE name = 'å¼ ä¸‰'; -- âœ… è¦†ç›–ç´¢å¼•
SELECT * FROM user WHERE name = 'å¼ ä¸‰';        -- âŒ éœ€è¦å›è¡¨

Q5ï¼šå¦‚ä½•åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µï¼Ÿ
EXPLAIN å…³é”®å­—æ®µï¼š

typeï¼šsystem > const > ref > range > index > ALLï¼ˆæœ€å¥½åˆ°æœ€å·®ï¼‰ã€‚
keyï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚
rowsï¼šé¢„ä¼°æ‰«æè¡Œæ•°ã€‚

Extraï¼š
Using indexï¼šè¦†ç›–ç´¢å¼•ã€‚
Using filesortï¼šéœ€è¦é¢å¤–æ’åºã€‚
Using temporaryï¼šç”¨äº†ä¸´æ—¶è¡¨ã€‚

Q5ï¼šå¤§è¡¨å¦‚ä½•æ·»åŠ ç´¢å¼•ï¼Ÿ
é—®é¢˜ï¼šç›´æ¥ ALTER TABLE ä¼šé”è¡¨ï¼Œé˜»å¡ä¸šåŠ¡ã€‚

è§£å†³æ–¹æ¡ˆï¼š
1ï¼‰åœ¨çº¿DDLå·¥å…·ï¼špt-online-schema-change (Percona Toolkit)ã€‚
2ï¼‰ä¸šåŠ¡ä½å³°æœŸæ“ä½œã€‚
3ï¼‰å…ˆåŠ ä»åº“ï¼Œå†åˆ‡æ¢ã€‚

Q6ï¼šä»€ä¹ˆæƒ…å†µä¸‹å»ºäº†ç´¢å¼•ä½†ç”¨ä¸ä¸Šï¼Ÿ
1) è¿åæœ€å·¦å‰ç¼€åŸåˆ™ï¼›
2) å¯¹ç´¢å¼•åˆ—åšäº†è®¡ç®—æˆ–å‡½æ•°ï¼›
3) å‘ç”Ÿäº†ç±»å‹éšå¼è½¬æ¢ï¼›
4) ä½¿ç”¨ORä¸”éƒ¨åˆ†åˆ—æ— ç´¢å¼•ï¼›
5) ä½¿ç”¨!=æˆ–NOT INï¼›
6) LIKEä»¥é€šé…ç¬¦å¼€å¤´ï¼›
7) ä¼˜åŒ–å™¨åˆ¤æ–­å…¨è¡¨æ‰«ææ›´å¿«ï¼ˆæ•°æ®é‡å°‘æ—¶ï¼‰ã€‚

Q7ï¼šå¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ
1) EXPLAINåˆ†ææ‰§è¡Œè®¡åˆ’ï¼›
2) æ£€æŸ¥æ˜¯å¦ç”¨ä¸Šåˆé€‚ç´¢å¼•ï¼›
3) è€ƒè™‘é‡å†™SQLï¼Œæ¯”å¦‚æ‹†åˆ†å¤æ‚æŸ¥è¯¢ã€ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼›
4) è°ƒæ•´ç´¢å¼•æˆ–è¡¨ç»“æ„ï¼›
5) å¯¹äºæ·±åˆ†é¡µç”¨id > xxx LIMITä¼˜åŒ–ã€‚


äº‹åŠ¡éš”ç¦»çº§åˆ«

éš”ç¦»çº§åˆ«	è„è¯»	ä¸å¯é‡å¤è¯»	å¹»è¯»	å®ç°æœºåˆ¶	æ€§èƒ½
è¯»æœªæäº¤
(Read Uncommitted)	âœ… å¯èƒ½	âœ… å¯èƒ½	âœ… å¯èƒ½	å‡ ä¹æ— é”	æœ€é«˜

è¯»å·²æäº¤
(Read Committed)	âŒ é¿å…	âœ… å¯èƒ½	âœ… å¯èƒ½	è¯­å¥çº§å¿«ç…§	é«˜

å¯é‡å¤è¯»
(Repeatable Read)	âŒ é¿å…	âŒ é¿å…	âœ… å¯èƒ½	äº‹åŠ¡çº§å¿«ç…§ + Gap Lock (MySQL)	ä¸­

ä¸²è¡ŒåŒ–
(Serializable)	        âŒ é¿å…	âŒ é¿å…	âŒ é¿å…	å®Œå…¨åŠ é”	æœ€ä½


è„è¯»ï¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡æœªæäº¤çš„æ•°æ®ã€‚
ä¸å¯é‡å¤è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡è¯»å–åŒä¸€è¡Œæ•°æ®ï¼Œç»“æœä¸åŒï¼ˆå› ä¸ºå…¶ä»–äº‹åŠ¡ä¿®æ”¹å¹¶æäº¤äº†ï¼‰ã€‚
å¹»è¯»ï¼šåŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä¸¤æ¬¡ç›¸åŒçš„èŒƒå›´æŸ¥è¯¢ï¼Œè¿”å›çš„è¡Œæ•°ä¸åŒï¼ˆå› ä¸ºå…¶ä»–äº‹åŠ¡æ’å…¥/åˆ é™¤å¹¶æäº¤äº†ï¼‰ã€‚

Q1ï¼šMySQLé»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ä»€ä¹ˆï¼Ÿè§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ
MySQL InnoDBçš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯ REPEATABLE READï¼ˆå¯é‡å¤è¯»ï¼‰ã€‚å®ƒé€šè¿‡MVCCè§£å†³äº†è„è¯»å’Œä¸å¯é‡å¤è¯»é—®é¢˜ã€‚å¯¹äºå¹»è¯»ï¼ŒInnoDBåœ¨REPEATABLE READä¸‹é€šè¿‡Next-Key Lockï¼ˆè®°å½•é”+é—´éš™é”ï¼‰åœ¨åŠ é”æŸ¥è¯¢ï¼ˆå¦‚SELECT ... FOR UPDATEï¼‰æ—¶å¯ä»¥é¿å…ï¼Œä½†æ™®é€šçš„å¿«ç…§è¯»ä»å¯èƒ½é‡åˆ°å¹»è¯»ã€‚æ‰€ä»¥MySQLçš„REPEATABLE READå®é™…ä¸Šæ¯”SQLæ ‡å‡†çš„è¦æ±‚æ›´ä¸¥æ ¼ã€‚


ä¸ºäº†è§£å†³å¹»è¯»ï¼ŒMySQLåœ¨REPEATABLE READä¸‹ä½¿ç”¨äº†Next-Key Lockingæœºåˆ¶ã€‚
1ï¼‰Next-Key Lock = Record Lock + Gap Lockï¼š
-- å‡è®¾usersè¡¨æ•°æ®ï¼š
-- id: 1, 3, 5, 7, 9
-- age: 20, 25, 30, 35, 40

-- äº‹åŠ¡1
START TRANSACTION;
SELECT * FROM users WHERE age = 30 FOR UPDATE;

-- Next-Key Locké”å®šçš„èŒƒå›´ï¼š
-- 1. Record Lockï¼šé”ä½age=30è¿™è¡Œ
-- 2. Gap Lockï¼šé”ä½(25, 30)å’Œ(30, 35)è¿™ä¸¤ä¸ªé—´éš™
-- 3. å…¶ä»–äº‹åŠ¡ä¸èƒ½åœ¨(25, 35)èŒƒå›´å†…æ’å…¥æ•°æ®

-- äº‹åŠ¡2å°è¯•æ’å…¥ä¼šè¢«é˜»å¡
START TRANSACTION;
INSERT INTO users (name, age) VALUES ('test', 28);  -- é˜»å¡ï¼Œå› ä¸º28åœ¨(25,30)é—´éš™
INSERT INTO users (name, age) VALUES ('test', 32);  -- é˜»å¡ï¼Œå› ä¸º32åœ¨(30,35)é—´éš™

2ï¼‰ä¸åŒæŸ¥è¯¢æ¡ä»¶çš„åŠ é”ç­–ç•¥
-- ç¤ºä¾‹æ•°æ®ï¼šid (1,3,5,7), age (18,22,25,30)

-- 1. ç­‰å€¼æŸ¥è¯¢ï¼ˆage = 25ï¼‰
SELECT * FROM users WHERE age = 25 FOR UPDATE;
-- åŠ é”ï¼šrecord lock (age=25) + gap lock (22,25) + gap lock (25,30)

-- 2. èŒƒå›´æŸ¥è¯¢ï¼ˆage > 20ï¼‰
SELECT * FROM users WHERE age > 20 FOR UPDATE;
-- åŠ é”ï¼šæ‰€æœ‰age>20çš„è®°å½•é” + æ‰€æœ‰ç›¸å…³é—´éš™é”
-- é˜»æ­¢åœ¨(20, âˆ)èŒƒå›´å†…æ’å…¥

-- 3. æ— åŒ¹é…è®°å½•çš„æŸ¥è¯¢ï¼ˆage = 23ï¼‰
SELECT * FROM users WHERE age = 23 FOR UPDATE;
-- åŠ é”ï¼šgap lock (22,25) 
-- è™½ç„¶æ²¡æ‰¾åˆ°è®°å½•ï¼Œä½†é”å®šäº†è¿™ä¸ªé—´éš™

Q2ï¼šå¦‚ä½•é€‰æ‹©éš”ç¦»çº§åˆ«ï¼Ÿ
è¯»å·²æäº¤ï¼ˆREAD COMMITTEDï¼‰ï¼šå¤§å¤šæ•°Webåº”ç”¨çš„é€‰æ‹©ã€‚å¹³è¡¡äº†æ€§èƒ½å’Œæ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…è„è¯»ï¼Œæ¥å—ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚Oracleé»˜è®¤ï¼Œæ¨èé‡‘èå¤–çš„å¤šæ•°åœºæ™¯ã€‚

å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰ï¼šéœ€è¦äº‹åŠ¡å†…æ•°æ®ä¸€è‡´æ€§çš„åœºæ™¯ï¼Œå¦‚å¯¹è´¦ã€æŠ¥è¡¨ç”Ÿæˆã€‚MySQLé»˜è®¤ã€‚

ä¸²è¡ŒåŒ–ï¼ˆSERIALIZABLEï¼‰ï¼šç»å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ï¼Œå¦‚é“¶è¡Œæ ¸å¿ƒäº¤æ˜“ï¼Œä½†æ€§èƒ½ä»£ä»·é«˜ã€‚

Q3ï¼šä»€ä¹ˆåœºæ™¯ä¸‹ä¼šç”¨åˆ° SERIALIZABLEï¼Ÿ
ä¸¤ç§å…¸å‹åœºæ™¯ï¼š

ä½™é¢æ£€æŸ¥ä¸æ‰£æ¬¾ï¼šéœ€è¦å…ˆSELECTæŸ¥ä½™é¢ï¼Œå†UPDATEæ‰£æ¬¾ã€‚åœ¨éä¸²è¡ŒåŒ–çº§åˆ«ä¸‹ï¼Œå…¶ä»–äº‹åŠ¡å¯èƒ½åœ¨ä¸¤è€…ä¹‹é—´ä¿®æ”¹ä½™é¢ï¼Œå¯¼è‡´è¶…é¢æ‰£æ¬¾ã€‚

å”¯ä¸€æ€§å¤æ‚æ ¡éªŒï¼šéœ€è¦æŸ¥è¯¢å¤šå¼ è¡¨åæ’å…¥ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€ã€‚å¯ç”¨SERIALIZABLEé…åˆSELECT ... FOR UPDATEï¼Œä½†å®é™…æ›´å¸¸ç”¨ä¹è§‚é”æˆ–åˆ†å¸ƒå¼é”æ›¿ä»£ï¼Œå› ä¸ºæ€§èƒ½æ›´å¥½ã€‚

Q4ï¼šå¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸‹ï¼š

äº‹åŠ¡Açš„æ“ä½œ	çœ‹åˆ°çš„æ•°æ®ç‰ˆæœ¬	åŸå› 
SELECTï¼ˆå¿«ç…§è¯»ï¼‰	1000ï¼ˆæ—§ç‰ˆæœ¬ï¼‰	MVCCï¼šä½¿ç”¨äº‹åŠ¡å¼€å§‹æ—¶çš„è¯»è§†å›¾ï¼ˆæ ¹æ®MVVCï¼Œçœ‹åˆ°çš„æ˜¯äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®å¿«ç…§ï¼‰
SELECT ... FOR UPDATE	900ï¼ˆæ–°ç‰ˆæœ¬ï¼‰	å½“å‰è¯»ï¼šç»•è¿‡MVCCï¼Œè¯»å–æœ€æ–°å·²æäº¤æ•°æ®å¹¶åŠ é”
UPDATE	900ï¼ˆæ–°ç‰ˆæœ¬ï¼‰	å½“å‰è¯»ï¼šå¿…é¡»åŸºäºæœ€æ–°æ•°æ®ä¿®æ”¹ï¼ˆäº‹åŠ¡Bä¿®æ”¹åçš„900ï¼‰

æ‰€ä»¥ï¼Œåœ¨æ¶‰åŠä½™é¢æ‰£å‡ã€åº“å­˜å‡å°‘ç­‰ä¸šåŠ¡åœºæ™¯ä¸­ï¼ŒSELECT ... FOR UPDATE ä¸æ˜¯å¯é€‰é¡¹ï¼Œè€Œæ˜¯å¿…é€‰é¡¹ï¼ˆå»ºè®® REPEATABLE READ + SELECT ... FOR UPDATEï¼‰

Q5ï¼š
UPDATE accounts SET balance=balance-? WHERE id=? AND balance>=?



JVM å†…å­˜æ¨¡å‹ï¼ˆç®€å•ï¼‰
Q1ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿ StackOverflowErrorï¼Ÿ
// ç¤ºä¾‹1ï¼šé€’å½’è°ƒç”¨æ— ç»ˆæ­¢æ¡ä»¶
public class StackOverflowDemo {
    public void infiniteRecursion() {
        infiniteRecursion();  // âŒ æ— é™é€’å½’ï¼Œæ ˆå¸§ä¸æ–­åˆ›å»º
    }
}

// ç¤ºä¾‹2ï¼šæ–¹æ³•è°ƒç”¨å±‚çº§è¿‡æ·±
public class DeepCallChain {
    public void level1() { level2(); }
    public void level2() { level3(); }
    // ... æŒç»­è°ƒç”¨å‡ ç™¾å±‚
    public void level1000() { /* æ“ä½œ */ }
}

// è§£å†³æ–¹æ¡ˆï¼š
public class SafeRecursion {
    // 1. è®¾ç½®é€’å½’ç»ˆæ­¢æ¡ä»¶
    public int factorial(int n) {
        if (n <= 1) return 1;  // âœ… ç»ˆæ­¢æ¡ä»¶
        return n * factorial(n - 1);
    }
    
    // 2. ä½¿ç”¨è¿­ä»£æ›¿ä»£é€’å½’
    public int factorialIterative(int n) {
        int result = 1;
        for (int i = 1; i <= n; i++) {
            result *= i;
        }
        return result;
    }
}

Q2ï¼šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‘ç”Ÿ Heap OOMï¼Ÿå¦‚ä½•æ’æŸ¥ï¼Ÿ
// å¸¸è§Heap OOMåœºæ™¯ï¼š
public class HeapOOMDemo {
    // 1. å†…å­˜æ³„éœ²
    private static final List<Object> LEAK_LIST = new ArrayList<>();
    
    public void memoryLeak() {
        while (true) {
            LEAK_LIST.add(new byte[1024 * 1024]);  // 1MB
            // å¯¹è±¡è¢«é™æ€é›†åˆå¼•ç”¨ï¼Œæ— æ³•GC
        }
    }
    
    // 2. å¤§å¯¹è±¡åˆ›å»º
    public void createLargeObjects() {
        List<byte[]> list = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            list.add(new byte[1024 * 1024 * 10]);  // 10MBæ¯ä¸ª
        }
    }
    
    // 3. è¿‡å¤šçº¿ç¨‹åˆ›å»ºå¯¹è±¡
    public void multiThreadOOM() {
        ExecutorService executor = Executors.newFixedThreadPool(100);
        for (int i = 0; i < 1000; i++) {
            executor.submit(() -> {
                byte[] data = new byte[1024 * 1024];  // æ¯ä¸ªçº¿ç¨‹1MB
                // å¤„ç†...
            });
        }
    }
}

Q3ï¼šSpring Boot ä¸­å¸¸è§çš„å†…å­˜æ³„éœ²åœºæ™¯ï¼Ÿ
@Component
public class CommonMemoryLeakInSpring {
    
    // 1. é™æ€é›†åˆå¼•ç”¨Spring Bean
    private static Map<String, Object> cache = new HashMap<>();
    
    @Autowired
    private UserService userService;
    
    @PostConstruct
    public void init() {
        cache.put("userService", userService);  // âŒ Spring Beanè¢«é™æ€å¼•ç”¨
    }
    
    // 2. ThreadLocalæœªæ¸…ç†
    private static ThreadLocal<HttpServletRequest> requestHolder = 
        new ThreadLocal<>();
    
    public void processRequest(HttpServletRequest request) {
        requestHolder.set(request);
        // ... ä¸šåŠ¡å¤„ç†
        
        // âŒ å¿˜è®°æ¸…ç†
        // requestHolder.remove();  // åº”è¯¥è°ƒç”¨
    }
    
    // 3. ç›‘å¬å™¨æœªå–æ¶ˆæ³¨å†Œ
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public void registerListener() {
        ApplicationListener<MyEvent> listener = event -> {
            // å¤„ç†äº‹ä»¶
        };
        
        eventPublisher.publishEvent(new MyEvent(this));
        // âŒ ç›‘å¬å™¨å¯èƒ½è¢«é•¿æœŸæŒæœ‰
    }
    
    // 4. å¤§é‡ç¼“å­˜æœªè®¾ç½®è¿‡æœŸ
    @Autowired
    private CacheManager cacheManager;
    
    public void cacheData(String key, Object value) {
        // âŒ æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´
        cacheManager.getCache("myCache").put(key, value);
    }
}

// æ’æŸ¥å·¥å…·å’Œå‘½ä»¤ï¼š
// 1. jps - æŸ¥çœ‹Javaè¿›ç¨‹
// 2. jstat -gc <pid> 1000 - GCç»Ÿè®¡
// 3. jmap -heap <pid> - å †ä¿¡æ¯
// 4. jmap -histo:live <pid> | head -20 - å¯¹è±¡ç»Ÿè®¡
// 5. jmap -dump:format=b,file=heap.hprof <pid> - å †è½¬å‚¨
// 6. jhat æˆ– MAT åˆ†æå †è½¬å‚¨æ–‡ä»¶



Q4ï¼šå¦‚ä½•ç›‘æ§ Spring Boot åº”ç”¨çš„å†…å­˜ä½¿ç”¨ï¼Ÿ
// 1. Spring Boot Actuator ç«¯ç‚¹
@Configuration
@EnableWebMvc
public class ActuatorConfig {
    // å¯ç”¨å†…å­˜ç›¸å…³ç«¯ç‚¹
}

// application.yml
management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,prometheus,heapdump"
  endpoint:
    health:
      show-details: always
    heapdump:
      enabled: true
  
  metrics:
    export:
      prometheus:
        enabled: true

// 2. è‡ªå®šä¹‰å†…å­˜ç›‘æ§
@Component
public class MemoryMonitor {
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿç›‘æ§ä¸€æ¬¡
    public void monitorMemory() {
        Runtime runtime = Runtime.getRuntime();
        long total = runtime.totalMemory();
        long free = runtime.freeMemory();
        long used = total - free;
        long max = runtime.maxMemory();
        
        double usedPercentage = (double) used / max * 100;
        
        if (usedPercentage > 80) {
            // å‘é€å‘Šè­¦
            alertService.sendAlert("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: " + usedPercentage + "%");
        }
        
        // è®°å½•åˆ°æ—¥å¿—
        log.info("Memory Usage - Used: {}MB, Free: {}MB, Max: {}MB, Usage: {}%",
                used / 1024 / 1024,
                free / 1024 / 1024,
                max / 1024 / 1024,
                String.format("%.2f", usedPercentage));
    }
}

// 3. ä½¿ç”¨Micrometerç›‘æ§
@Bean
public MeterRegistryCustomizer<MeterRegistry> metricsCommonTags() {
    return registry -> registry.config().commonTags(
        "application", "myapp",
        "region", System.getenv("REGION")
    );
}

// 4. é›†æˆAPMå·¥å…·
// SkyWalkingã€Pinpointã€Arthasç­‰


Q5ï¼šå¦‚ä½•ä¼˜åŒ– Spring Boot åº”ç”¨çš„å†…å­˜ä½¿ç”¨ï¼Ÿ
// å®æˆ˜ä¼˜åŒ–æ–¹æ¡ˆï¼š
@Configuration
public class MemoryOptimizationConfig {
    
    // 1. Beanä¼˜åŒ–
    @Bean
    @Scope("prototype")  // æŒ‰éœ€åˆ›å»ºï¼Œé¿å…å•ä¾‹æŒæœ‰è¿‡å¤šæ•°æ®
    public ExpensiveBean expensiveBean() {
        return new ExpensiveBean();
    }
    
    // 2. ä½¿ç”¨å¼±å¼•ç”¨ç¼“å­˜
    @Bean
    public CacheManager cacheManager() {
        return new ConcurrentMapCacheManager() {
            @Override
            protected Cache createConcurrentMapCache(String name) {
                return new ConcurrentMapCache(name, 
                    CacheBuilder.newBuilder()
                        .maximumSize(1000)
                        .expireAfterWrite(10, TimeUnit.MINUTES)
                        .weakValues()  // ä½¿ç”¨å¼±å¼•ç”¨ï¼Œå†…å­˜ä¸è¶³æ—¶å¯è¢«GC
                        .build().asMap(),
                    false);
            }
        };
    }
    
    // 3. æµå¼å¤„ç†å¤§æ•°æ®ï¼šæµå¤„ç†ï¼Œä½¿ç”¨ç¼“å†²åŒºï¼Œæ¯æ¬¡åªè¯»å–ä¸€å°éƒ¨åˆ†æ•°æ®åˆ°å†…å­˜
    @Service
    public class StreamProcessingService {
        
        @Transactional(readOnly = true)
        public void processLargeData() {
            // âŒ é”™è¯¯ï¼šä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®
            // List<User> users = userRepository.findAll();
            
            // âœ… æ­£ç¡®ï¼šä½¿ç”¨æµå¼æŸ¥è¯¢
            try (Stream<User> userStream = userRepository.findAllByStream()) {
                userStream
                    .filter(user -> user.isActive())
                    .forEach(this::processUser);
            }
        }
    }
    
    // 4. åˆç†ä½¿ç”¨Session
    @Configuration
    @EnableRedisHttpSession(
        maxInactiveIntervalInSeconds = 1800,  // 30åˆ†é’Ÿè¿‡æœŸ
        redisNamespace = "mysession"
    )
    public class SessionConfig {
        // ä½¿ç”¨Rediså­˜å‚¨Sessionï¼Œé¿å…å†…å­˜ä¸­å­˜å‚¨å¤§é‡Session
    }
    
    // 5. å›¾ç‰‡/æ–‡ä»¶å¤„ç†ä¼˜åŒ–
    @Service
    public class ImageService {
        
        public void processImage(MultipartFile file) throws IOException {
            // âŒ é”™è¯¯ï¼šç›´æ¥è¯»å–åˆ°byte[]
            // byte[] data = file.getBytes();
            
            // âœ… æ­£ç¡®ï¼šä½¿ç”¨æµå¤„ç†
            try (InputStream is = file.getInputStream();
                 BufferedImage image = ImageIO.read(is)) {
                // å¤„ç†å›¾ç‰‡
            }
        }
    }
    
    // 6. çº¿ç¨‹æ± ä¼˜åŒ–
    @Bean
    public Executor asyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);          // æ ¸å¿ƒçº¿ç¨‹æ•°
        executor.setMaxPoolSize(10);          // æœ€å¤§çº¿ç¨‹æ•°
        executor.setQueueCapacity(100);       // é˜Ÿåˆ—å®¹é‡
        executor.setThreadNamePrefix("Async-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}

Q6ï¼šSpring ç®¡ç†çš„ Bean æœ‰å‡ ç§ä½œç”¨åŸŸï¼š
@Component
public class BeanScopeDemo {
    
    // 1. singletonï¼ˆé»˜è®¤ï¼‰ï¼šæ•´ä¸ªSpringå®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹
    @Scope("singleton")  // æˆ– @Scope(ConfigurableBeanFactory.SCOPE_SINGLETON)
    @Bean
    public SingletonBean singletonBean() {
        // æ¯æ¬¡getBean()è¿”å›åŒä¸€ä¸ªå®ä¾‹
        return new SingletonBean();
    }
    
    // 2. prototypeï¼šæ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°å®ä¾‹
    @Scope("prototype")  // æˆ– @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    @Bean
    public PrototypeBean prototypeBean() {
        // æ¯æ¬¡getBean()è¿”å›æ–°å®ä¾‹
        return new PrototypeBean();
    }
    
    // 3. å…¶ä»–Webç›¸å…³ä½œç”¨åŸŸï¼ˆéœ€è¦Webç¯å¢ƒï¼‰
    // request: æ¯ä¸ªHTTPè¯·æ±‚ä¸€ä¸ªæ–°å®ä¾‹
    // session: æ¯ä¸ªç”¨æˆ·ä¼šè¯ä¸€ä¸ªæ–°å®ä¾‹  
    // application: ServletContextç”Ÿå‘½å‘¨æœŸ
    // websocket: WebSocketä¼šè¯ç”Ÿå‘½å‘¨æœŸ
}

Q7ï¼šç”µå•†å¤§ä¿ƒæœŸé—´å†…å­˜é£™å‡
é¢è¯•å®˜ï¼šåŒ11æœŸé—´ï¼Œä½ çš„Spring Bootåº”ç”¨å†…å­˜ä½¿ç”¨ç‡ä»40%çªç„¶æ¶¨åˆ°90%ï¼Œå¦‚ä½•å¿«é€Ÿå®šä½å’Œè§£å†³ï¼Ÿ

            1. ç«‹å³è¡ŒåŠ¨ï¼ˆ5åˆ†é’Ÿå†…ï¼‰ï¼š
               a. æŸ¥çœ‹ç›‘æ§ï¼šæ£€æŸ¥GCé¢‘ç‡ã€å †å†…å­˜åˆ†å¸ƒ ï¼ˆæ–¹æ³•ä¸€ï¼šä½¿ç”¨ jstat å‘½ä»¤è¡Œå·¥å…·ï¼Œjps -mlï¼Œjstat -gc <pid> 1000 10ã€‚æ–¹æ³•äºŒï¼šSpring Boot Actuator ç›‘æ§ï¼Œcurl http://localhost:8080/actuator/metrics/jvm.memory.usedï¼Œcurl http://localhost:8080/actuator/metrics/jvm.gc.memory.allocatedï¼‰
               b. é‡å¯å®ä¾‹ï¼šå¿«é€Ÿæ¢å¤æœåŠ¡ï¼ˆå…ˆé‡å¯ä¸€ä¸ªå®ä¾‹ï¼‰

# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# é‡å¯æœåŠ¡
sudo systemctl restart myapp

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status myapp

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u myapp -f

               c. æ‰©å®¹ï¼šä¸´æ—¶å¢åŠ å®ä¾‹æ•°
            
            2. è¯Šæ–­åŸå› ï¼ˆ15åˆ†é’Ÿï¼‰ï¼š
               a. è·å–å †è½¬å‚¨ï¼šjmap -dump:live,format=b,file=heap.hprof <pid>
               b. åˆ†æçº¿ç¨‹ï¼šjstack <pid> > thread.txt
               c. æ£€æŸ¥ä¸šåŠ¡ï¼šæ˜¯å¦æœ‰å¤§ä¿ƒç‰¹å®šä»£ç è·¯å¾„
            
            3. å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š
               a. ç¼“å­˜å‡»ç©¿ï¼šå¤§é‡è¯·æ±‚æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
                  â†’ è§£å†³æ–¹æ¡ˆï¼šå¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜
               
               b. æ…¢æŸ¥è¯¢ï¼šæ•°æ®åº“æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®
                  â†’ è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ åˆ†é¡µã€ä¼˜åŒ–ç´¢å¼•
               
               c. å†…å­˜æ³„æ¼ï¼šæ´»åŠ¨Sessionè¿‡å¤š
                  â†’ è§£å†³æ–¹æ¡ˆï¼šè°ƒæ•´Sessionè¶…æ—¶æ—¶é—´
               
               d. ä»£ç Bugï¼šæ— é™å¾ªç¯åˆ›å»ºå¯¹è±¡
                  â†’ è§£å†³æ–¹æ¡ˆï¼šä»£ç å®¡æŸ¥ã€ä¿®å¤Bug
            
            4. é¢„é˜²æªæ–½ï¼š
               a. å‹åŠ›æµ‹è¯•ï¼šæå‰æ¨¡æ‹Ÿå¤§ä¿ƒæµé‡
               b. ç†”æ–­é™çº§ï¼šé…ç½®Hystrix/Sentinel
               c. ç›‘æ§å‘Šè­¦ï¼šè®¾ç½®å†…å­˜é˜ˆå€¼å‘Šè­¦
               d. é™æµï¼šé…ç½®æ¥å£QPSé™åˆ¶

Q8ï¼šSpring Bootåº”ç”¨å¯åŠ¨æ…¢
é¢è¯•å®˜ï¼šSpring Bootåº”ç”¨å¯åŠ¨éœ€è¦2åˆ†é’Ÿï¼Œå¦‚ä½•ä¼˜åŒ–åˆ°30ç§’å†…ï¼Ÿ

    1. ç±»åŠ è½½ä¼˜åŒ–
       - å‡å°‘ä¾èµ–ï¼šç§»é™¤ä¸å¿…è¦çš„starter
       - æ‰«æä¼˜åŒ–ï¼š@ComponentScanæŒ‡å®šbasePackages ï¼ˆæ‰«æ Spring ç®¡ç†çš„ç»„ä»¶ï¼š@Component, @Service, @Repository, @Controllerï¼Œ@RestController, @Configurationï¼Œè‡ªå®šä¹‰æ³¨è§£ã€‚ä¸æ‰«ææ™®é€šJavaç±»ï¼šDTO/VO/POJO æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ŒEntity å®ä½“ï¼ˆJPAå•ç‹¬å¤„ç†ï¼‰ï¼ŒUtil å·¥å…·ç±»ï¼ŒConstants å¸¸é‡ç±»ï¼ŒEnums æšä¸¾ç±»ï¼‰

// ä¼ä¸šçº§æ¨¡æ¿
@SpringBootApplication(
    scanBasePackages = "com.company.project",  // Spring Bootè‡ªåŠ¨é…ç½®+æŒ‡å®šåŒ…
    exclude = {
        DataSourceAutoConfiguration.class,      // æ’é™¤ä¸éœ€è¦çš„è‡ªåŠ¨é…ç½®
        SecurityAutoConfiguration.class         // è‡ªå®šä¹‰å®‰å…¨é…ç½®
    }
)
@ComponentScan(
    basePackages = {
        "com.company.project.module.web",
        "com.company.project.module.service",
        "com.company.project.module.repository",
        "com.company.project.shared.config"
    },
    excludeFilters = @Filter(
        type = FilterType.REGEX,
        pattern = {
            ".*\\.dto\\..*",
            ".*\\.vo\\..*", 
            ".*\\.util\\..*",
            ".*\\.constant\\..*"
        }
    )
)
@EntityScan(basePackages = "com.company.project.module.entity")
@EnableJpaRepositories(basePackages = "com.company.project.module.repository")
public class EnterpriseApplication {
    
    // æ˜¾å¼å¯¼å…¥é¢å¤–é…ç½®
    @Import({
        ThirdPartyIntegrationConfig.class,
        MonitoringConfig.class,
        CacheConfig.class
    })
    @Configuration
    static class AdditionalConfig {
    }
}

       - å»¶è¿ŸåŠ è½½ï¼šspring.main.lazy-initialization=true ï¼ˆé»˜è®¤falseï¼Œå¯åŠ¨æ—¶ç«‹å³åˆå§‹åŒ–æ‰€æœ‰Beanã€‚è®¾ç½®ä¸º trueï¼Œå»¶è¿Ÿåˆå§‹åŒ–ï¼Œå¯åŠ¨æ—¶åªåˆ›å»ºBeanå®šä¹‰ï¼Œä½¿ç”¨æ—¶æ‰åˆå§‹åŒ–ã€‚ï¼‰
        
    2. Beanåˆå§‹åŒ–ä¼˜åŒ–
       - @Lazyæ³¨è§£ï¼šå»¶è¿Ÿåˆå§‹åŒ–
       - å¼‚æ­¥åˆå§‹åŒ–ï¼šé…ç½®å¼‚æ­¥Bean
        
    3. JVMä¼˜åŒ–
       - è°ƒæ•´å †å¤§å°ï¼šé¿å…åŠ¨æ€æ‰©å®¹
       - ä½¿ç”¨AOTï¼šSpring Nativeï¼ˆGraalVMï¼‰
       - åˆ†å±‚ç¼–è¯‘ï¼š-XX:+TieredCompilation
        
    4. é…ç½®ä¼˜åŒ–
       - å…³é—­JMXï¼šspring.jmx.enabled=false
       - ç²¾ç®€é…ç½®ï¼šç§»é™¤ä¸éœ€è¦çš„è‡ªåŠ¨é…ç½®
        
    5. ä»£ç ä¼˜åŒ–
       - å‡å°‘@PostConstructä¸­çš„è€—æ—¶æ“ä½œ
       - å¼‚æ­¥æ‰§è¡Œåˆå§‹åŒ–ä»»åŠ¡




å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ˜¯"å…³äºæ•°æ®çš„æ•°æ®"

// å¥½æ¯”å•†å“çš„ä»·æ ¼æ ‡ç­¾ï¼š
å•†å“ï¼šè‹¹æœ            â† å®é™…æ•°æ®
ä»·æ ¼ï¼šÂ¥5.0            â† å®é™…æ•°æ®
ç”Ÿäº§æ—¥æœŸï¼š2024-01-15   â† å®é™…æ•°æ®

"ä»·æ ¼æ ‡ç­¾çš„æ ¼å¼"         â† å…ƒæ•°æ®ï¼ˆæè¿°ä»·æ ¼æ•°æ®å¦‚ä½•å±•ç¤ºï¼‰
"æ—¥æœŸçš„æ˜¾ç¤ºè§„åˆ™"         â† å…ƒæ•°æ®
"å•†å“åˆ†ç±»çš„æ–¹æ³•"         â† å…ƒæ•°æ®

æ³¨è§£ï¼ˆAnnotationsï¼‰ - æœ€å¸¸è§çš„å…ƒæ•°æ®



ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ
ç®€å•å®šä¹‰ï¼šåå°„ï¼ˆReflectionï¼‰æ˜¯ Java åœ¨è¿è¡Œæ—¶æ£€æŸ¥ã€ä¿®æ”¹è‡ªèº«ç»“æ„å’Œè¡Œä¸ºçš„èƒ½åŠ›ã€‚





ç‰¹æ€§	@Component	@Bean
æ³¨è§£ä½ç½®	ç±»çº§åˆ«ï¼ˆClassï¼‰	æ–¹æ³•çº§åˆ«ï¼ˆMethodï¼‰
ä½¿ç”¨åœºæ™¯	è‡ªå·±ç¼–å†™çš„ç±»	ç¬¬ä¸‰æ–¹åº“çš„ç±»ã€éœ€è¦å®šåˆ¶çš„Bean
æ§åˆ¶ç²’åº¦	ç®€å•å®ä¾‹åŒ–	å®Œå…¨æ§åˆ¶å®ä¾‹åŒ–è¿‡ç¨‹
ä¾èµ–æ³¨å…¥	é€šè¿‡å­—æ®µ/æ„é€ å™¨	é€šè¿‡æ–¹æ³•å‚æ•°



7.1 é™¤äº† findByï¼ŒSpring Data JPA è¿˜æ”¯æŒå¾ˆå¤šæ¨å¯¼å…³é”®å­—ï¼Œå®ƒä»¬éƒ½éµå¾ªç›¸åŒçš„æ¨¡å¼ï¼š

// ç›¸ç­‰æŸ¥è¯¢
List<Task> findByUserId(Long userId);
// å¤šæ¡ä»¶ AND
List<Task> findByUserIdAndStatus(Long userId, String status);
// æ’åº
List<Task> findByUserIdOrderByCreatedAtDesc(Long userId);
// å­˜åœ¨æ€§
boolean existsByUserId(Long userId);
// è®¡æ•°
long countByUserId(Long userId);
// åˆ é™¤
void deleteByUserId(Long userId);

7.2 æ¶‰åŠé‡‘é¢å¿…é¡»ç”¨ BigDecimal ï¼Œåƒ double/float ä¼šæœ‰ç²¾åº¦æŸå¤±

æ„é€ å¯¹è±¡ï¼š
new BigDecimal("0.1") // âœ… ä½¿ç”¨å­—ç¬¦ä¸²æ„é€ 
BigDecimal.valueOf(0.1) // âœ… å†…éƒ¨å·²å¤„ç†

æ¯”è¾ƒå’Œæ’åºï¼š
bd1.compareTo(bd2) == 0 // âœ… æ¯”è¾ƒå€¼.æ³¨æ„ï¼šequals()è¿˜æ¯”è¾ƒç²¾åº¦(scale)ï¼Œ1.0â‰ 1.00
bd1 == bd2 æˆ– bd1.equals(bd2) // âŒ

ç®—æœ¯è¿ç®—:
bd1.add(bd2) // âœ… åŠ æ³•
bd1.multiply(bd2) // âœ… ä¹˜æ³•
bd1 + bd2 // âŒ Javaä¸æ”¯æŒè¿ç®—ç¬¦é‡è½½

bd1.divide(bd2, 2, RoundingMode.HALF_UP) // âœ… æŒ‡å®šå°æ•°ä½å’Œèˆå…¥æ¨¡å¼
bd1.divide(bd2) // âŒ å¯èƒ½é™¤ä¸å°½æŠ›å¼‚å¸¸

è®¾ç½®ç²¾åº¦ï¼š
bd.setScale(2, RoundingMode.HALF_UP) // âœ… å››èˆäº”å…¥


7.3 é‡æ–°åŠ è½½mavenä¾èµ–
æ–¹æ³•1ï¼šIDEåˆ·æ–°ï¼ˆæ¨èï¼‰
åœ¨ IntelliJ IDEA ä¸­ï¼š

å³é”®ç‚¹å‡»é¡¹ç›®æ ¹ç›®å½•çš„ pom.xml
é€‰æ‹© Maven â†’ Reload Project

æ–¹æ³•2ï¼šå‘½ä»¤è¡Œ
cd /Users/dengmuwen/Documents/codes/www/my_java_code/demo-api
mvn clean install

cd /Users/dengmuwen/Documents/codes/www/my_java_code/demo-api && mvn dependency:resolve -q


7.4 Mavenå‘½ä»¤
a. â€Œmvn clean package
æ¸…ç†é¡¹ç›®ï¼ˆæ¸…ç† target/ ç›®å½•ï¼‰ï¼Œcompile ç¼–è¯‘ä»£ç ï¼Œtest è¿è¡Œæµ‹è¯•ã€æŒ‡å®špackageæ‰“åŒ…

æ€»ç»“æ¥è¯´ï¼Œmvn clean package æ˜¯å°† Spring Boot 2 åº”ç”¨æ‰“åŒ…ä¸ºç‹¬ç«‹å¯æ‰§è¡Œ JAR æ–‡ä»¶çš„æ ‡å‡†ã€æ¨èå‘½ä»¤ï¼Œæ˜¯éƒ¨ç½²åˆ°ç”Ÿäº§æˆ–æµ‹è¯•ç¯å¢ƒå‰çš„å¿…è¦æ­¥éª¤ã€‚â€Œ

b. â€Œmvn clean install
æ¸…ç†é¡¹ç›®ï¼ˆæ¸…ç† target/ ç›®å½•ï¼‰ï¼Œcompile ç¼–è¯‘ä»£ç ï¼Œtest è¿è¡Œæµ‹è¯•ã€æŒ‡å®špackageæ‰“åŒ…ã€‚å¹¶å°†ç”Ÿæˆçš„åŒ…æ–‡ä»¶å®‰è£…åˆ°æœ¬åœ°Mavenä»“åº“ã€‚


7.5 Java VS PHP
ç»´åº¦	Java (Spring Boot)	PHP (Laravel)
æ‰§è¡Œæ–¹å¼	ç¼–è¯‘ + å¸¸é©»å†…å­˜	è§£é‡Š + è¯·æ±‚å³é”€æ¯
æ€§èƒ½	è¿è¡Œå¿«ï¼Œå¯åŠ¨æ…¢ï¼Œå¸¸é©»å†…å­˜çš„"é•¿æœŸå·¥ä½œè€…"ï¼ˆç¼–è¯‘å‹ + JVM + JITï¼ŒJavaå¿«æ˜¯å› ä¸ºæœ‰JITï¼‰ï¼Œå¤„ç†é«˜å¹¶å‘ã€‚	å¯åŠ¨å¿«ï¼Œè¿è¡Œç›¸å¯¹æ…¢ã€‚è¯·æ±‚å³é”€æ¯çš„"ä¸´æ—¶å·¥"ï¼ˆè§£é‡Šå‹ + CGIï¼‰
ç±»å‹ç³»ç»Ÿ	é™æ€å¼ºç±»å‹	åŠ¨æ€å¼±ç±»å‹
å¹¶å‘å¤„ç†	å¼ºå¤§ï¼ˆå¤šçº¿ç¨‹ï¼‰ï¼Œå¯ä»¥å…±äº«æ•°æ®åº“è¿æ¥æ± 	æœ‰é™ï¼ˆå¤šè¿›ç¨‹ï¼‰ï¼Œæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹è¿æ¥ï¼Œ1000ä¸ªå¹¶å‘åˆ™å¯èƒ½åˆ›å»º 1000 ä¸ªæ•°æ®åº“è¿æ¥ã€‚ç°åœ¨æœ‰äº†Workerman/Swooleä¹Ÿå¯ä»¥å¸¸é©»å†…å­˜äº†ã€‚


ï¼ˆ1ï¼‰å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚
Javaï¼š
1. ç”¨æˆ·è®¿é—® /api/users
2. JVM å·²è¿è¡Œï¼Œç›´æ¥è°ƒç”¨å·²æœ‰å¯¹è±¡
3. å“åº”æ—¶é—´ï¼š50ms

PHPï¼š
1. ç”¨æˆ·è®¿é—® /api/users
2. Nginx æ”¶åˆ°è¯·æ±‚ â†’ å¯åŠ¨ PHP-FPM è¿›ç¨‹
3. PHP è§£é‡Šå™¨è¯»å–æ–‡ä»¶ â†’ æ‰§è¡Œä»£ç 
4. å“åº”æ—¶é—´ï¼š100ms


ï¼ˆ2ï¼‰å¤„ç†ç¬¬ 1000 ä¸ªè¯·æ±‚
Javaï¼š
1. ç”¨æˆ·è®¿é—® /api/users
2. ç›´æ¥è°ƒç”¨å†…å­˜ä¸­çš„å¯¹è±¡
3. å“åº”æ—¶é—´ï¼š20msï¼ˆJIT ä¼˜åŒ–åæ›´å¿«ï¼‰
4. å†…å­˜ï¼šè¿˜æ˜¯ 300MB

PHPï¼š
1. ç”¨æˆ·è®¿é—® /api/users
2. å¯èƒ½åˆ›å»ºæ–°çš„ PHP è¿›ç¨‹
3. é‡æ–°è§£é‡Šæ‰§è¡Œ
4. å“åº”æ—¶é—´ï¼š100msï¼ˆä¸ç¬¬ä¸€æ¬¡å·®ä¸å¤šï¼‰
5. å†…å­˜ï¼šç´¯ç§¯ä½¿ç”¨ï¼Œä½†æ¯ä¸ªè¯·æ±‚åé‡Šæ”¾


7.6 JVM ï¼ˆJava Virtual Machineï¼‰ æ˜¯ Java çš„è™šæ‹Ÿè®¡ç®—æœºï¼Œ
æºä»£ç  (.java)
    â†“ ç¼–è¯‘
å­—èŠ‚ç  (.class)      â† è¿™æ˜¯å¹³å°æ— å…³çš„
    â†“
JVM åŠ è½½å­—èŠ‚ç 
    â†“
JVM è§£é‡Šæ‰§è¡Œ
    â†“
æ“ä½œç³»ç»Ÿ + CPU

JVM è®©javaåœ¨å„ç§ç¯å¢ƒéƒ½èƒ½è·‘èµ·æ¥ã€‚



// JVM å†…å­˜ç»“æ„ï¼ˆç®€åŒ–ï¼‰
JVM å†…å­˜åŒºåŸŸï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ–¹æ³•åŒºï¼ˆMethod Areaï¼‰         â”‚ â† å­˜å‚¨ç±»ä¿¡æ¯ã€å¸¸é‡æ± 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         å †ï¼ˆHeapï¼‰                   â”‚ â† æ‰€æœ‰å¯¹è±¡éƒ½åœ¨è¿™é‡Œï¼ˆGC ç®¡ç†ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ ˆï¼ˆStackï¼‰                  â”‚ â† çº¿ç¨‹ç§æœ‰ï¼Œå­˜å‚¨å±€éƒ¨å˜é‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       ç¨‹åºè®¡æ•°å™¨ï¼ˆPC Registerï¼‰        â”‚ â† å½“å‰æ‰§è¡Œä½ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰   â”‚ â† è°ƒç”¨æœ¬åœ°æ–¹æ³•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// å¯åŠ¨ JVM æ—¶çš„é‡è¦å‚æ•°
java -Xms512m    # åˆå§‹å †å¤§å°
     -Xmx1024m   # æœ€å¤§å †å¤§å°
     -Xss256k    # æ¯ä¸ªçº¿ç¨‹æ ˆå¤§å°
     -jar app.jar ï¼ˆapp.jar æ–‡ä»¶é‡Œ ç¼–è¯‘åç”Ÿæˆçš„.class æ–‡ä»¶æ˜¯æ ¸å¿ƒï¼‰


7.7 JITï¼šè®© Java é£èµ·æ¥çš„å…³é”®
JITï¼ˆJust-In-Time Compilationï¼Œå³æ—¶ç¼–è¯‘ï¼‰ æ˜¯ JVM çš„æ€§èƒ½åŠ é€Ÿå™¨


æ²¡æœ‰ JIT æ—¶ï¼š
Java å­—èŠ‚ç  â†’ JVM è§£é‡Šæ‰§è¡Œ â†’ æœ‰ç‚¹æ…¢

æœ‰ JIT æ—¶ï¼š
çƒ­ç‚¹ä»£ç ï¼ˆç»å¸¸æ‰§è¡Œçš„ä»£ç ï¼‰ â†’ JIT ç¼–è¯‘æˆæœ¬åœ°æœºå™¨ç  â†’ ç›´æ¥æ‰§è¡Œ â†’ å¾ˆå¿«ï¼


JIT å°±åƒç»™ Java è£…äº†ä¸ªè®°å¿†èŠ¯ç‰‡ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶è®°ä½æ€ä¹ˆåšï¼Œä»¥åç›´æ¥ç…§åšï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°æƒ³ï¼ˆè§£é‡Šï¼‰ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Java è¶Šè·‘è¶Šå¿«ï¼Œè€Œ PHPï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰æ¯æ¬¡éƒ½è¦é‡æ–°æƒ³ã€‚

7.8 éƒ¨ç½²javaåˆ°ç”Ÿäº§ç¯å¢ƒ

æ–¹æ³•ä¸€ï¼šä½¿ç”¨å¯æ‰§è¡ŒJARï¼ˆæœ€å¸¸è§ï¼‰
1ï¼‰æ‰“åŒ…
# Maven
mvn clean package
# è¾“å‡ºï¼štarget/ä½ çš„åº”ç”¨å.jar

# Gradle
./gradlew bootJar
# è¾“å‡ºï¼šbuild/libs/ä½ çš„åº”ç”¨å.jar

2ï¼‰ä¼ è¾“ï¼šå°†JARæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨

3ï¼‰è¿è¡Œï¼šä½¿ç”¨java -jar
# æœ€åŸºæœ¬å¯åŠ¨
java -jar /opt/app/ä½ çš„åº”ç”¨å.jar

# ç”Ÿäº§ç¯å¢ƒæ¨èï¼šæŒ‡å®šå†…å­˜ã€GCç­‰å‚æ•°ï¼Œå¹¶åœ¨åå°è¿è¡Œ
nohup java -Xms512m -Xmx1024m -XX:+UseG1GC -jar /opt/app/ä½ çš„åº”ç”¨å.jar \
     --server.port=8080 \
     > /opt/app/app.log 2>&1 &

4ï¼‰é…ç½®nginxè¿›è¡Œåå‘ä»£ç†åˆ°8080ã€‚

æ–¹æ³•äºŒï¼š
ä½¿ç”¨ç³»ç»ŸæœåŠ¡ç®¡ç†å™¨ï¼ˆå¦‚ systemd æˆ– supervisorï¼‰æ¥ç®¡ç†Javaè¿›ç¨‹ï¼Œå®ç°å¼€æœºè‡ªå¯ã€æ•…éšœé‡å¯ã€æ—¥å¿—è½®è½¬ç­‰

æ–¹æ³•ä¸‰ï¼š
Docker

7.9 Java å¼‚å¸¸
Java ä¸­æœ‰ä¸¤ç§å¼‚å¸¸ï¼š

å—æ£€å¼‚å¸¸ (Checked Exception)ï¼šå¿…é¡»è¢«æ•è·æˆ–å£°æ˜æŠ›å‡º
éå—æ£€å¼‚å¸¸ (Runtime Exception)ï¼šå¯ä»¥ä¸å¤„ç†

7.10 Spring ä¾èµ–æ³¨å…¥çš„æ³¨è§£
// 1. @Component - é€šç”¨ç»„ä»¶
@Component  // æœ€é€šç”¨ï¼Œä»»ä½•ç±»éƒ½å¯ä»¥ç”¨
public class MyService { ... }

// 2. @Service - ä¸šåŠ¡é€»è¾‘å±‚
@Service    // è¯­ä¹‰åŒ–ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸šåŠ¡æœåŠ¡
public class UserService { ... }

// 3. @Repository - æ•°æ®è®¿é—®å±‚  
@Repository // è¯­ä¹‰åŒ–ï¼Œè¡¨ç¤ºè¿™æ˜¯æ•°æ®è®¿é—®ç»„ä»¶
public class UserRepository { ... }

// 4. @Controller - Webæ§åˆ¶å™¨å±‚
@Controller // å¤„ç†HTTPè¯·æ±‚
public class UserController { ... }

// 5. @RestController = @Controller + @ResponseBody
@RestController // REST APIæ§åˆ¶å™¨
public class ApiController { ... }

// 6. @Configuration - é…ç½®ç±»
@Configuration // åŒ…å«@Beanæ–¹æ³•çš„é…ç½®ç±»
public class AppConfig { ... }



æ³¨è§£	ç”¨é€”	ç‰¹æ®Šå¤„ç†	ç¤ºä¾‹
@Component	é€šç”¨ç»„ä»¶	æ— 	å·¥å…·ç±»ã€æ‹¦æˆªå™¨ã€è¿‡æ»¤å™¨
@Service	ä¸šåŠ¡æœåŠ¡	äº‹åŠ¡ä»£ç†	UserService, OrderService
@Repository	æ•°æ®è®¿é—®	å¼‚å¸¸è½¬æ¢	UserRepository, ProductRepository
@Controller	Webæ§åˆ¶å™¨	è¯·æ±‚æ˜ å°„	UserControllerï¼ˆä¼ ç»Ÿè¿”å›è§†å›¾çš„ MVC æ§åˆ¶å™¨ï¼‰
@RestController	RESTæ§åˆ¶å™¨	è‡ªåŠ¨@ResponseBody	ApiControllerï¼ˆRESTful APIï¼‰
@Configuration	é…ç½®ç±»	ä»£ç†æ¨¡å¼	SecurityConfig, WebConfig




7.11 
è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯

æ–¹å¼ä¸€ï¼šRequestå±æ€§ï¼ˆHttpServletRequestï¼‰
ä¼˜ç‚¹ï¼š
âœ… å®ç°ç®€å•ç›´æ¥
âœ… æ— éœ€é¢å¤–ä¾èµ–
âœ… è‡ªåŠ¨éšè¯·æ±‚é“¾ä¼ é€’
ç¼ºç‚¹ï¼š
âŒ åªåœ¨å½“å‰è¯·æ±‚å‘¨æœŸå†…æœ‰æ•ˆ
âŒ ä¸é€‚åˆå¼‚æ­¥æ“ä½œï¼Œå› ä¸ºRequest å¯¹è±¡åªåœ¨å½“å‰è¯·æ±‚çº¿ç¨‹ä¸­æœ‰æ•ˆï¼Œå¦‚æœæœ‰å¼‚æ­¥åˆ›å»ºäº†æ–°çº¿ç¨‹ï¼Œåˆ™è·å–ä¸åˆ°äº†ã€‚

æ–¹å¼äºŒï¼šSpring Securityï¼ˆSecurityContextï¼‰
ä¼˜ç‚¹ï¼š
âœ… Spring å®˜æ–¹æ¨èæ–¹æ¡ˆ
âœ… æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œå¯ä»¥ä»ä¸»çº¿ç¨‹æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯
âœ… åŠŸèƒ½å®Œæ•´ï¼ˆæƒé™ã€è§’è‰²ç®¡ç†ç­‰ï¼‰
âœ… ç”Ÿæ€å®Œå–„
ç¼ºç‚¹ï¼š
âŒ éœ€è¦å¼•å…¥ Spring Security ä¾èµ–
âŒ å­¦ä¹ æˆæœ¬ç¨é«˜
âŒ éœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰


7.12 è¿‡æ»¤å™¨ vs æ‹¦æˆªå™¨ vs åˆ‡é¢
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯
    â†“
è¿‡æ»¤å™¨ (Filter)          â† æœ€æ—©ï¼ŒServlet å±‚é¢
    â†“
DispatcherServlet
    â†“
æ‹¦æˆªå™¨ (Interceptor)      â† Spring MVC å±‚é¢
    â†“
Controller
    â†“
åˆ‡é¢ (Aspect)            â† æ–¹æ³•çº§åˆ«ï¼Œæœ€çµæ´»
    â†“
Serviceä¸šåŠ¡é€»è¾‘


7.13 Request Body æ—¥å¿—è®°å½• - å®ç°è¯´æ˜
a. é—®é¢˜ï¼šä¹‹å‰ log.info("Request Body: {}", request.getAttribute("requestBody")) è¿”å› null

b. åŸå› ï¼šHTTP Request Body åªèƒ½è¯»å–ä¸€æ¬¡ï¼š

Servlet çš„ InputStream è¯»å–åå°±å…³é—­äº†
Spring MVC åœ¨å‚æ•°ç»‘å®šæ—¶å·²ç»è¯»å–äº† Body
åœ¨ AOP åˆ‡é¢ä¸­å†æ¬¡è¯»å–æ—¶ï¼Œæµå·²ç»ç©ºäº†

c. è§£å†³æ–¹æ¡ˆ
RepeatedlyReadRequestWrapperï¼ˆRequest åŒ…è£…å™¨ï¼‰
åŸå§‹ Request
    â†“
è¯»å– InputStream å¹¶ç¼“å­˜åˆ° byte[]
    â†“
é‡å†™ getInputStream() æ–¹æ³•
    â†“
æ¯æ¬¡è°ƒç”¨æ—¶ä»ç¼“å­˜çš„ byte[] åˆ›å»ºæ–°çš„æµ
    â†“
å®ç°å¯é‡å¤è¯»å–

d. RequestBodyCacheFilterï¼ˆè¿‡æ»¤å™¨ï¼‰

ä½œç”¨ï¼š

æ‹¦æˆªæ‰€æœ‰ HTTP è¯·æ±‚
å¯¹ POST/PUT/PATCH è¯·æ±‚åŒ…è£…æˆå¯é‡å¤è¯»å–çš„ Request
å°† Body å†…å®¹è®¾ç½®åˆ° request å±æ€§ä¸­

7.14 Spring Security
åŸºäºURLï¼Œå¯¹äºæ¥å£çš„è®¿é—®æ§åˆ¶ï¼šä¸»è¦æ˜¯é€šè¿‡ Servlet Filter é“¾ å®ç°çš„ã€‚è¿™æ˜¯ä½ å¿…é¡»ç†è§£å’Œé…ç½®çš„åŸºç¡€ã€‚
@Override
protected void configure(HttpSecurity http) throws Exception {
    http.authorizeRequests()
        .antMatchers("/api/admin/**").hasRole("ADMIN") // /api/admin/ ä¸‹çš„æ¥å£éœ€è¦ADMINè§’è‰²
        .antMatchers("/api/user/**").hasAnyRole("USER", "ADMIN") // éœ€è¦USERæˆ–ADMINè§’è‰²
        .antMatchers("/api/public/**").permitAll() // å…¬å¼€è®¿é—®
        .anyRequest().authenticated() // å…¶ä»–æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯
        .and()
        .addFilterBefore(new JwtTokenFilter(), UsernamePasswordAuthenticationFilter.class); // æ·»åŠ JWTè¿‡æ»¤å™¨
}

åŸºäºæ–¹æ³•ï¼Œå¯¹äºæ›´å¤æ‚ã€åŸºäºä¸šåŠ¡é€»è¾‘çš„æƒé™åˆ¤æ–­ï¼šåº”ä½¿ç”¨åŸºäº Spring AOP çš„ @PreAuthorize ç­‰æ³¨è§£ã€‚ä¾‹å¦‚ï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½åˆ é™¤â€œè‡ªå·±å‘å¸ƒçš„â€æ–‡ç« ï¼Œè¿™ç§ä¾èµ–æ•°æ®èº«ä»½çš„æƒé™ï¼Œéå¸¸é€‚åˆç”¨ @PreAuthorize(â€œ@permissionService.checkOwnership(#id, principal)â€) æ¥å®ç°

@RestController
@RequestMapping("/api/products")
public class ProductController {
    @DeleteMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or @permissionService.canDeleteProduct(#id, principal)") // æ”¯æŒSpELè¡¨è¾¾å¼ï¼Œå¯è°ƒç”¨è‡ªå®šä¹‰é€»è¾‘
    public ResponseEntity<?> deleteProduct(@PathVariable Long id) {
        // åˆ é™¤å•†å“é€»è¾‘
    }
}



